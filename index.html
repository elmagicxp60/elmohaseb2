<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام المحاسبة البسيط</title>

    <style>
        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }

        .pagination-controls button {
            padding: 8px 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .pagination-controls button:hover {
            background: #2980b9;
        }

        .pagination-controls button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .pagination-controls span {
            color: #2c3e50;
            font-weight: bold;
        }




        body {
            font-family: 'Segoe UI', 'Arial', sans-serif;
            margin: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            height: 200vh;
            background: linear-gradient(180deg, #2c3e50 0%, #3498db 100%);
            padding: 25px;
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.2);
        }

        .main-content {
            flex: 1;
            padding: 30px;
            background: rgba(255, 255, 255, 0.9);
            margin: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .button {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 15px 0;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .button:active {
            transform: translateY(0);
        }

        h1 {
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: white;
            margin-bottom: 40px;
            font-size: 28px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .section-content {
            display: none;
            padding: 20px;
            animation: fadeIn 0.5s ease;
        }

        .section-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .section-title {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .new-invoice-btn {
            background: #27ae60;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
            transition: background 0.3s;
        }

        .new-invoice-btn:hover {
            background: #219a52;
        }

        .invoice-form {
            display: none;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .invoice-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            width: 80%;
            max-width: 800px;
            /* تصغير عرض النموذج من 900 إلى 600 */
            margin: 50px auto;
            padding: 20px;
            border-radius: 10px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .invoice-table th,
        .invoice-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: right;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .add-item-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            margin: 10px 0;
            cursor: pointer;
        }

        .close {
            float: left;
            cursor: pointer;
            font-size: 24px;
        }

        .customer-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        select.form-control {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 0 2px;
            color: white;
        }

        .details-btn {
            background: #3498db;
        }

        .delete-invoice-btn {
            background: #e74c3c;
        }

        .ship-btn {
            background: #2ecc71;
        }

        .shipped {
            background-color: rgba(34, 220, 43, 0.2); /* أحمر شفاف بنسبة 50% */

        }

        .receipt-style {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 380px;
            margin: 0 auto;
            font-size: 14px;
        }

        .receipt-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px dashed #000;
        }

        .receipt-header h2 {
            color: #2c3e50;
            margin: 0 0 10px 0;
            font-size: 24px;
        }

        .receipt-header p {
            margin: 5px 0;
            color: #666;
        }

        .receipt-customer {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .receipt-customer p {
            margin: 8px 0;
            color: #2c3e50;
        }

        .receipt-customer strong {
            display: inline-block;
            width: 80px;
            color: #34495e;
        }

        .receipt-items {
            width: 100%;
            margin: 20px 0;
            border-collapse: collapse;
        }

        .receipt-items th {
            background: #f8f9fa;
            padding: 10px;
            color: #2c3e50;
            font-weight: bold;
            border-bottom: 2px dashed #000;
        }

        .receipt-items td {
            padding: 8px;
            border-bottom: 1px solid #eee;
            color: #666;
        }

        .receipt-items tr:last-child td {
            border-bottom: none;
        }

        .receipt-total {
            margin-top: 20px;
            padding: 15px 0;
            border-top: 2px dashed #000;
            text-align: left;
            font-size: 16px;
        }

        .receipt-footer {
            text-align: center;
            margin-top: 25px;
            padding-top: 15px;
            border-top: 2px dashed #000;
        }

        .receipt-footer p {
            color: #666;
            margin-bottom: 15px;
        }

        .product-image-preview {
            max-width: 200px;
            max-height: 200px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
        }

        .image-upload-container {
            border: 2px dashed #ddd;
            padding: 20px;
            text-align: center;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .image-upload-container:hover {
            border-color: #3498db;
        }

        .product-form-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .image-preview-container {
            position: relative;
            display: inline-block;
        }

        .remove-image-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            display: none;
        }

        .remove-image-btn:hover {
            background: #c0392b;
        }

        .large-image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            cursor: pointer;
        }

        .large-image {
            max-width: 90%;
            max-height: 90vh;
            margin: auto;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        }

        .info-btn {
            background: #2980b9;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-style: italic;
            font-family: serif;
        }

        .cancel-btn {
            background: #e74c3c;
        }

        .return-btn {
            background: #f39c12;
        }

        .paid-btn {
            background: #27ae60;
            
        }

        .shipping-row-cancelled {
            background-color: #fadbd8 !important;
        }

        .shipping-row-returned {
            background-color: #fef9e7 !important;
        }

        .shipping-row-paid {
            background-color: #d4efdf !important;
        }

        .suggestions {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 150px;
            overflow-y: auto;
            width: calc(100% - 2px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
        }

        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
        }

        .suggestion-item:hover {
            background: #f0f0f0;
        }

        .settings-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .settings-card h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .fa-whatsapp {
            margin-left: 5px;
            font-size: 16px;
        }

        /* تحسين تجاوب الشريط الجانبي */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                position: sticky;
                top: 0;
                z-index: 100;
            }

            .main-content {
                margin: 10px;
                padding: 15px;
            }

            .button {
                padding: 10px;
                margin: 8px 0;
                font-size: 16px;
            }

            h1 {
                font-size: 24px;
                margin-bottom: 20px;
            }
        }

        /* تحسين تجاوب نموذج الفاتورة */
        @media (max-width: 576px) {
            .modal-content {
                width: 95%;
                margin: 20px auto;
            }

            .form-row,
            .form-row-3 {
                grid-template-columns: 1fr;
            }

            .receipt-style {
                max-width: 100%;
                padding: 15px;
                font-size: 12px;
            }

            .receipt-footer button {
                padding: 8px 12px;
                font-size: 14px;
            }
        }

        /* تعديل أحجام الأزرار في الريسيت */
        .receipt-footer .new-invoice-btn {
            padding: 8px 15px;
            font-size: 14px;
            margin: 5px;
        }

        /* تحسين عرض الجداول */
        @media (max-width: 576px) {
            .invoice-table {
                display: block;
                overflow-x: auto;
            }

            .invoice-table th,
            .invoice-table td {
                min-width: 100px;
                font-size: 14px;
            }
        }

        /* تحسين تجاوب الأزرار والمدخلات */
        .action-btn {
            padding: 4px 8px;
            font-size: 12px;
        }

        @media (max-width: 400px) {
            .new-invoice-btn {
                width: 100%;
                margin-bottom: 10px;
            }

            .form-group input,
            .form-group select {
                font-size: 14px;
            }
        }

        /* تحسين مظهر الإيصال للشاشات الصغيرة */
        @media print,
        (max-width: 576px) {
            .receipt-header h2 {
                font-size: 18px;
            }

            .receipt-header p {
                font-size: 12px;
            }

            .receipt-customer p {
                font-size: 12px;
            }

            .receipt-items th,
            .receipt-items td {
                padding: 6px;
                font-size: 12px;
            }

            .receipt-total {
                font-size: 14px;
            }
        }

        /* تحسين مظهر الصور */
        .product-image-preview {
            max-width: 100%;
            height: auto;
        }

        /* تحسين تجاوب نموذج QR */
        @media (max-width: 576px) {
            .qr-modal {
                max-width: 95%;
            }

            #qrCode {
                width: 200px;
                height: 200px;
            }
        }

        /* تحسين تباعد العناصر */
        .section-content {
            padding: 10px;
        }

        @media (min-width: 769px) {
            .section-content {
                padding: 20px;
            }
        }


        .button i {
            margin-left: 10px;
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .sidebar h1 i {
            margin-left: 10px;
            animation: spin 4s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .button {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 15px 20px;
        }

        .button:hover i {
            transform: scale(1.2);
            transition: transform 0.3s ease;
        }


        .share-options {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }

        .share-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .share-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .share-btn i {
            font-size: 20px;
        }

        .share-btn:nth-child(2) {
            background: #9b59b6;
        }

        .share-btn:nth-child(3) {
            background: #25D366;
        }

        .qr-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 20px;
        }

        .qr-container p {
            text-align: center;
            color: #555;
            max-width: 300px;
        }

        .qr-container .app-link {
            font-weight: bold;
            color: #3498db;
            word-break: break-all;
            text-align: center;
            margin-top: 10px;
        }

        .copy-success {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(46, 204, 113, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 2000;
            animation: fadeInOut 2s ease forwards;
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0;
            }

            20% {
                opacity: 1;
            }

            80% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }

        @media (max-width: 576px) {
            .share-options {
                flex-direction: column;
            }

            .share-btn {
                width: 100%;
            }
        }

        .search-box {
            position: relative;
            width: 300px;
        }

        .search-input {
            width: 100%;
            padding: 10px 35px 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
            outline: none;
        }

        .search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }





        /* أضف هذا الكود في قسم <style> */

        .notifications-icon {
            position: relative;
            margin-right: 20px;
            cursor: pointer;
        }

        .notifications-icon i {
            color: white;
            font-size: 24px;
        }

        .notifications-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .notifications-panel {
            position: fixed;
            top: 60px;
            left: 20px;
            width: 300px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 1000;
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .notification-message {
            color: #666;
            font-size: 14px;
        }

        .notification-time {
            color: #999;
            font-size: 12px;
        }

        .notification-item.unread {
            background: #f8f9fa;
        }

        .notification-item.unread::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #3498db;
            border-radius: 50%;
            display: inline-block;
            margin-left: 5px;
        }

        .edit-btn {
            background: #f39c12;
            margin: 0 2px;
        }

        .edit-btn:hover {
            background: #d68910;
        }





        /* أنماط أزرار التنقل بين الصفحات */
        #invoicesPagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }

        #invoicesPagination button {
            padding: 8px 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }

        #invoicesPagination button:hover {
            background: #2980b9;
        }

        #invoicesPagination button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        #invoicesPagination span {
            color: #2c3e50;
            font-weight: bold;
        }




        @keyframes highlight {
            0% {
                background-color: transparent;
            }

            50% {
                background-color: rgba(202, 211, 12, 0.3);
                /* لون #cad30c مع شفافية */
            }

            100% {
                background-color: transparent;
            }
        }

        .highlight-row {
            animation: highlight 2s ease-in-out 3;
        }



        /*إضافة CSS لتنسيق شارات الحالة*/

.status-badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    text-align: center;
    min-width: 55px;
    color: white;
}

.status-pending {
    background-color: #f1c40f;
    border: 1px solid #f39c12;
}

.status-delivered {
    background-color: #2ecc71;
    border: 1px solid #27ae60;
}

.status-cancelled {
    background-color: #e74c3c;
    border: 1px solid #c0392b;
}

.status-returned {
    background-color: #e67e22;
    border: 1px solid #d35400;
}

.status-paid {
    background-color: #3498db;
    border: 1px solid #2980b9;
}






        .profits-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
        }

        .profits-table th,
        .profits-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #ddd;
        }

        .profits-table tbody tr:hover {
            background-color: #f5f6fa;
        }

        .profits-table tfoot {
            font-weight: bold;
        }

        .profits-table tfoot td {
            border-top: 2px solid #ddd;
        }



        .profits-pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    margin-top: 20px;
    margin-bottom: 20px;
}

.profits-pagination button {
    padding: 8px 15px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.3s;
}

.profits-pagination button:hover {
    background: #2980b9;
}

.profits-pagination button:disabled {
    background: #bdc3c7;
    cursor: not-allowed;
}

.profits-pagination span {
    color: #2c3e50;
    font-weight: bold;
}



.filter-controls {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.date-input {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.filter-btn {
    padding: 8px 15px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.3s;
}

.filter-btn:hover {
    background: #2980b9;
}

.filter-btn i {
    margin-right: 5px;
}







    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- إضافة مكتبات Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <script>


        // تكوين Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCk9KgkP9IBBJSuyjCp-UYeokZ2dhsYZcw",
            authDomain: "sales-app-8af4e.firebaseapp.com",
            databaseURL: "https://sales-app-8af4e-default-rtdb.firebaseio.com",
            projectId: "sales-app-8af4e",
            storageBucket: "sales-app-8af4e.firebasestorage.app",
            messagingSenderId: "198138512819",
            appId: "1:198138512819:web:b88ccd8b62b361e6c6f7c6",
            measurementId: "G-0JWBSL3V9D"
        };

        // تهيئة Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const storage = firebase.storage();

        // دوال مساعدة للتعامل مع Firebase
        const firebaseHelper = {
            // حفظ البيانات
            saveData: function (path, data) {
                return database.ref(path).set(data);
            },

            // استرجاع البيانات
            getData: function (path) {
                return database.ref(path).once('value').then(snapshot => snapshot.val());
            },

            // رفع الصور
            uploadImage: function (path, file) {
                return storage.ref(path).put(file);
            },

            // الحصول على رابط الصورة
            getImageUrl: function (path) {
                return storage.ref(path).getDownloadURL();
            }
        };

        // تحميل البيانات عند بدء التطبيق
        // تحميل البيانات عند بدء التطبيق
        window.onload = async function () {
            try {
                // تحميل البيانات من Firebase
                const [savedRates, savedInvoices, savedProducts, savedClients] = await Promise.all([
                    firebaseHelper.getData('shippingRates'),
                    firebaseHelper.getData('invoices'),
                    firebaseHelper.getData('products'),
                    firebaseHelper.getData('clients')
                ]);

                // تحميل أسعار الشحن
                if (savedRates) {
                    shippingRates = savedRates;
                }

                // تحميل الفواتير
                if (savedInvoices) {
                    invoices = savedInvoices;
                    // تحديث رقم آخر فاتورة
                    const lastNumber = getLastInvoiceNumber();
                    invoiceCounter = lastNumber + 1;
                    updateInvoicesTable();
                }

                // تحميل المنتجات
                if (savedProducts) {
                    products = savedProducts;
                    updateProductsList();
                }

                // تحميل العملاء
                if (savedClients) {
                    clients = savedClients;
                    updateClientsList();
                }

                // مراقبة التغييرات في الفواتير
                database.ref('invoices').on('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        invoices = data;
                        updateInvoicesTable();
                        updateShipmentsTable();
                    }
                });

                // تحديث جدول الشحنات إذا كان قسم الشحنات مفتوحاً
                if (document.getElementById('shipping').classList.contains('active')) {
                    updateShipmentsTable();
                }

                // عرض قسم الفواتير افتراضياً
                showSection('invoices');

                // تهيئة نظام الإشعارات
                initNotifications();

                console.log('تم تحميل البيانات بنجاح');

            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
                addNotification(
                    'خطأ في التحميل',
                    'حدث خطأ أثناء تحميل البيانات. يرجى تحديث الصفحة',
                    'error'
                );
            }
        };
    </script>
    <script>
        // دالة لتقسيم الصفحات
        function paginateTable(tableId, data, rowsPerPage, currentPage) {
            const tableBody = document.querySelector(`#${tableId} tbody`);
            const totalPages = Math.ceil(data.length / rowsPerPage);
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;

            // عرض البيانات في الصفحة الحالية فقط
            const pageData = data.slice(start, end);
            tableBody.innerHTML = pageData.join('');

            // تحديث أزرار التنقل
            const paginationControls = document.querySelector(`#${tableId}-pagination`);
            paginationControls.innerHTML = `
            <button onclick="changePage('${tableId}', ${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>السابق</button>
            <span>صفحة ${currentPage} من ${totalPages}</span>
            <button onclick="changePage('${tableId}', ${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>التالي</button>
        `;
        }

        // دالة لتغيير الصفحة
        function changePage(tableId, newPage) {
            const tableData = window[`${tableId}Data`]; // البيانات المخزنة
            const rowsPerPage = 15; // عدد الصفوف لكل صفحة
            if (newPage > 0 && newPage <= Math.ceil(tableData.length / rowsPerPage)) {
                paginateTable(tableId, tableData, rowsPerPage, newPage);
            }
        }

        // تعديل دالة updateInvoicesTable


        // التأكد من تحميل البيانات عند بدء التطبيق
        document.addEventListener('DOMContentLoaded', () => {
            updateInvoicesTable();
        });

        // تعديل دالة editInvoice
        function editInvoice(index) {
            const invoice = invoices[index];
            const modal = document.getElementById('invoiceModal');

            // تعيين مؤشر التعديل
            modal.dataset.editIndex = index;

            // تعبئة البيانات في النموذج
            document.getElementById('invoiceNumber').value = invoice.number;
            document.getElementById('invoiceDate').value = invoice.date;
            document.getElementById('customerName').value = invoice.customer;
            document.getElementById('phone').value = invoice.phone || '';
            document.getElementById('governorate').value = invoice.governorate || '';
            document.getElementById('address').value = invoice.address || '';

            // تفريغ جدول المنتجات
            const invoiceItems = document.getElementById('invoiceItems');
            invoiceItems.innerHTML = '';

            // إضافة المنتجات
            invoice.items.forEach(item => {
                const row = invoiceItems.insertRow();
                const uniqueId = 'item_' + Date.now() + Math.random();

                row.innerHTML = `
            <td>
                <div class="form-group" style="margin:0">
                    <input type="text" class="item-name" id="${uniqueId}" value="${item.name}" required>
                </div>
            </td>
            <td><input type="number" class="item-price" value="${item.price}" onchange="calculateRowTotal(this)" required></td>
            <td><input type="number" class="item-quantity" value="${item.quantity}" onchange="calculateRowTotal(this)" required></td>
            <td><input type="number" class="item-total" value="${item.total}" readonly></td>
            <td><button class="delete-btn" onclick="deleteRow(this)">حذف</button></td>
        `;

                // إضافة الاقتراحات للمنتج
                setupAutoComplete(uniqueId, products, 'name', (product) => {
                    if (product) {
                        const priceInput = row.querySelector('.item-price');
                        priceInput.value = product.sellPrice;
                        calculateRowTotal(priceInput);
                    }
                });
            });

            // تحديث الإجمالي
            document.getElementById('totalAmount').value = invoice.total;

            // عرض النموذج
            modal.style.display = 'block';
        }
    </script>
</head>

<body>
    <div class="sidebar">
        <h1><i class="fas fa-calculator"></i> FARFASHA SYSTEM</h1>


        <!-- أضف هذا الكود بعد عنوان الموقع في الـ sidebar -->
        <div class="notifications-icon" onclick="toggleNotifications()">
            <i class="fas fa-bell"></i>
            <span class="notifications-count">0</span>
        </div>
        <button class="button" onclick="showSection('invoices')">
            <i class="fas fa-file-invoice"></i>
            الفواتير
        </button>
        <button class="button" onclick="showSection('products')">
            <i class="fas fa-box-open"></i>
            المنتجات
        </button>
        <button class="button" onclick="showSection('clients')">
            <i class="fas fa-users"></i>
            العملاء
        </button>
        <button class="button" onclick="showSection('shipping')">
            <i class="fas fa-shipping-fast"></i>
            الشحنات
        </button>
        <button class="button" onclick="showSection('reports')">
            <i class="fas fa-chart-bar"></i>
            التقارير
        </button>
        <button class="button" onclick="showSection('settings')">
            <i class="fas fa-cog"></i>
            الإعدادات
        </button>
    </div>

    <div class="main-content">

        <div id="invoices" class="section-content">
            <h2 class="section-title">قسم الفواتير</h2>



            <div id="invoiceForm" class="invoice-form">
                <h3>إنشاء فاتورة جديدة</h3>
                <div class="form-group">
                    <label>رقم الفاتورة</label>
                    <input type="text" placeholder="أدخل رقم الفاتورة">
                </div>
                <div class="form-group">
                    <label>اسم العميل</label>
                    <input type="text" placeholder="أدخل اسم العميل">
                </div>
                <div class="form-group">
                    <label>المبلغ</label>
                    <input type="number" placeholder="أدخل المبلغ">
                </div>
                <button class="new-invoice-btn" onclick="saveInvoice()">حفظ الفاتورة</button>
            </div>
        </div>
        <div id="products" class="section-content">
            <h2 class="section-title">قسم المنتجات</h2>
            <div id="productsList"></div>
        </div>




        <!-- قسم العملاء -->

        <div id="clients" class="section-content">
            <h2 class="section-title">قسم العملاء</h2>
            <button class="new-invoice-btn" onclick="showNewClientForm()">إضافة عميل جديد</button>
            <div id="clientsList"></div>
        </div>

        <!-- نموذج إضافة عميل جديد -->
        <div id="clientModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeClientModal()">&times;</span>
                <h2>إضافة عميل جديد</h2>

                <div class="product-form-container">
                    <div class="form-group">
                        <label>اسم العميل</label>
                        <input type="text" id="clientName" required>
                    </div>

                    <div class="form-group">
                        <label>المحافظة</label>
                        <select id="clientGovernorate" class="form-control" required>
                            <option value="">اختر المحافظة</option>
                            <option value="القاهرة">القاهرة</option>
                            <option value="الجيزة">الجيزة</option>
                            <option value="الإسكندرية">الإسكندرية</option>
                            <option value="الدقهلية">الدقهلية</option>
                            <option value="البحر الأحمر">البحر الأحمر</option>
                            <option value="البحيرة">البحيرة</option>
                            <option value="الفيوم">الفيوم</option>
                            <option value="الغربية">الغربية</option>
                            <option value="الإسماعيلية">الإسماعيلية</option>
                            <option value="المنوفية">المنوفية</option>
                            <option value="المنيا">المنيا</option>
                            <option value="القليوبية">القليوبية</option>
                            <option value="الوادي الجديد">الوادي الجديد</option>
                            <option value="السويس">السويس</option>
                            <option value="اسوان">اسوان</option>
                            <option value="اسيوط">اسيوط</option>
                            <option value="بني سويف">بني سويف</option>
                            <option value="بورسعيد">بورسعيد</option>
                            <option value="دمياط">دمياط</option>
                            <option value="الشرقية">الشرقية</option>
                            <option value="جنوب سيناء">جنوب سيناء</option>
                            <option value="كفر الشيخ">كفر الشيخ</option>
                            <option value="مطروح">مطروح</option>
                            <option value="الأقصر">الأقصر</option>
                            <option value="قنا">قنا</option>
                            <option value="شمال سيناء">شمال سيناء</option>
                            <option value="سوهاج">سوهاج</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>رقم الهاتف</label>
                        <input type="tel" id="clientPhone" required>
                    </div>

                    <div class="form-group">
                        <label>العنوان بالتفصيل</label>
                        <input type="text" id="clientAddress" required>
                    </div>

                    <button class="new-invoice-btn" onclick="saveClient()">حفظ العميل</button>
                </div>
            </div>
        </div>
        <div id="shipping" class="section-content">
            <h2 class="section-title">قسم الشحنات</h2>
            <p>محتوى قسم الشحنات يظهر هنا</p>
        </div>
        <div id="reports" class="section-content">
            <h2 class="section-title">قسم التقارير</h2>

            <div class="settings-grid">
                <div class="settings-card">
                    <h3><i class="fas fa-chart-line"></i> الأرباح</h3>
                    <p>عرض تقرير مفصل عن أرباح المبيعات</p>
                    <button class="share-btn" onclick="showProfitsReport()">
                        <i class="fas fa-search-dollar"></i>
                        عرض تقرير الأرباح
                    </button>
                </div>
            </div>
            `;
        </div>

        <!-- إضافة نموذج تقرير الأرباح -->
        <div id="profitsModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeProfitsModal()">&times;</span>
                <h2>تقرير الأرباح</h2>
                <table class="profits-table">
                    <thead>
                        <tr>
                            <th style="background-color: #3498db; color: white;">رقم الفاتورة</th>
                            <th style="background-color: #e74c3c; color: white;">تكلفة الشراء</th>
                            <th style="background-color: #2ecc71; color: white;">سعر البيع</th>
                            <th style="background-color: #f39c12; color: white;">الخصم</th>
                            <th style="background-color: #9b59b6; color: white;">صافي الربح</th>
                        </tr>
                    </thead>
                    <tbody id="profitsTableBody"></tbody>
                    <tfoot>
                        <tr>
                            <td style="background-color: #f5f6fa;">الإجمالي</td>
                            <td style="background-color: #f5f6fa;" id="totalBuying"></td>
                            <td style="background-color: #f5f6fa;" id="totalValue"></td>
                            <td style="background-color: #f5f6fa;" id="totalDiscount"></td>
                            <td style="background-color: #f5f6fa;" id="totalProfit"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>





        <div id="settings" class="section-content">
            <h2 class="section-title">الإعدادات</h2>
            <div class="settings-card">
                <h3><i class="fas fa-share-alt"></i> مشاركة التطبيق</h3>
                <p>يمكنك مشاركة رابط التطبيق مع الآخرين عبر الطرق التالية:</p>

                <div class="share-options">
                    <button class="share-btn" onclick="generateQRCode()">
                        <i class="fas fa-qrcode"></i>
                        مشاركة عبر QR Code
                    </button>

                    <button class="share-btn" onclick="copyAppLink()">
                        <i class="fas fa-copy"></i>
                        نسخ رابط التطبيق
                    </button>

                    <button class="share-btn" onclick="shareViaWhatsApp()">
                        <i class="fab fa-whatsapp"></i>
                        مشاركة عبر واتساب
                    </button>

                </div>

            </div>
            <!-- إضافة بطاقة إعدادات الشحن -->
            <div class="settings-card">
                <h3><i class="fas fa-truck"></i> إعدادات الشحن</h3>
                <p>قم بتحديد أسعار الشحن لكل محافظة</p>
                <button class="share-btn" onclick="showShippingSettings()">
                    <i class="fas fa-cog"></i>
                    ضبط أسعار الشحن
                </button>
            </div>
        </div>
    </div>


    <!-- إضافة نموذج إعدادات الشحن -->
    <div id="shippingSettingsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeShippingSettings()">&times;</span>
            <h2>إعدادات أسعار الشحن</h2>
            <table class="invoice-table">
                <thead>
                    <tr>
                        <th>المحافظة</th>
                        <th>سعر الشحن</th>
                        <th>مدة التوصيل (أيام)</th>
                    </tr>
                </thead>
                <tbody id="shippingRatesTable"></tbody>
            </table>
            <button class="new-invoice-btn" onclick="saveShippingSettings()" style="margin-top: 20px;">
                حفظ الإعدادات
            </button>
        </div>
    </div>





    <div id="invoiceModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeInvoiceModal()">&times;</span>
            <h2>فاتورة جديدة</h2>

            <!-- رقم الفاتورة والتاريخ -->
            <div class="form-row">
                <div class="form-group">
                    <label>رقم الفاتورة</label>
                    <input type="text" id="invoiceNumber" readonly>
                </div>
                <div class="form-group">
                    <label>التاريخ</label>
                    <input type="text" id="invoiceDate" readonly>
                </div>
            </div>

            <!-- معلومات العميل -->
            <div class="form-row-3">
                <div class="form-group">
                    <label>اسم العميل</label>
                    <input type="text" id="customerName" required>
                </div>
                <div class="form-group">
                    <label>المحافظة</label>
                    <select id="governorate" class="form-control" required>
                        <option value="">اختر المحافظة</option>
                        <option value="القاهرة">القاهرة</option>
                        <option value="الجيزة">الجيزة</option>
                        <option value="الإسكندرية">الإسكندرية</option>
                        <option value="الدقهلية">الدقهلية</option>
                        <option value="البحر الأحمر">البحر الأحمر</option>
                        <option value="البحيرة">البحيرة</option>
                        <option value="الفيوم">الفيوم</option>
                        <option value="الغربية">الغربية</option>
                        <option value="الإسماعيلية">الإسماعيلية</option>
                        <option value="المنوفية">المنوفية</option>
                        <option value="المنيا">المنيا</option>
                        <option value="القليوبية">القليوبية</option>
                        <option value="الوادي الجديد">الوادي الجديد</option>
                        <option value="السويس">السويس</option>
                        <option value="اسوان">اسوان</option>
                        <option value="اسيوط">اسيوط</option>
                        <option value="بني سويف">بني سويف</option>
                        <option value="بورسعيد">بورسعيد</option>
                        <option value="دمياط">دمياط</option>
                        <option value="الشرقية">الشرقية</option>
                        <option value="جنوب سيناء">جنوب سيناء</option>
                        <option value="كفر الشيخ">كفر الشيخ</option>
                        <option value="مطروح">مطروح</option>
                        <option value="الأقصر">الأقصر</option>
                        <option value="قنا">قنا</option>
                        <option value="شمال سيناء">شمال سيناء</option>
                        <option value="سوهاج">سوهاج</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>رقم الهاتف</label>
                    <input type="tel" id="phone" required>
                </div>
            </div>

            <!-- العنوان -->
            <div class="form-group">
                <label>العنوان بالتفصيل</label>
                <input type="text" id="address" required>
            </div>

            <!-- إضافة حقل قيمة التوصيل -->
            <div class="form-group">
                <label>قيمة التوصيل</label>
                <input type="number" id="shippingCost" readonly>
                <small class="delivery-info" style="color: #666; display: block; margin-top: 5px;"></small>
            </div>


            <table class="invoice-table">
                <thead>
                    <tr>
                        <th>اسم المنتج</th>
                        <th>السعر</th>
                        <th>الكمية</th>
                        <th>الإجمالي</th>
                        <th>حذف</th>
                    </tr>
                </thead>
                <tbody id="invoiceItems">
                </tbody>
            </table>

            <button class="add-item-btn" onclick="addInvoiceItem()">إضافة منتج</button>

            <div class="form-group">
                <label>إجمالي الفاتورة</label>
                <input type="text" id="totalAmount" readonly>
            </div>

            <div class="form-group">
                <label>الخصم</label>
                <input type="number" id="discountAmount" value="0" onchange="calculateInvoiceTotal()">
            </div>

            <div class="form-group">
                <label>الإجمالي النهائي</label>
                <input type="text" id="finalTotalAmount" readonly>
            </div>

            <button class="new-invoice-btn" onclick="saveFullInvoice()">حفظ الفاتورة</button>
        </div>
    </div>

    <!-- نموذج إضافة منتج جديد -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeProductModal()">&times;</span>
            <h2>إضافة منتج جديد</h2>

            <div class="product-form-container">
                <div class="form-group">
                    <label>اسم المنتج</label>
                    <input type="text" id="productName" required>
                </div>

                <div class="form-group">
                    <label>سعر الشراء</label>
                    <input type="number" id="buyPrice" required>
                </div>

                <div class="form-group">
                    <label>سعر البيع</label>
                    <input type="number" id="sellPrice" required>
                </div>

                <div class="form-group">
                    <label>الكمية</label>
                    <input type="number" id="quantity" required>
                </div>

                <div class="form-group">
                    <label>صورة المنتج</label>
                    <div class="image-upload-container" onclick="document.getElementById('productImage').click()">
                        <p>انقر لاختيار صورة</p>
                        <input type="file" id="productImage" accept="image/*" style="display: none"
                            onchange="previewImage(this)">
                    </div>
                    <div class="image-preview-container">
                        <img id="imagePreview" class="product-image-preview">
                        <button class="remove-image-btn" onclick="removeImage()">&times;</button>
                    </div>
                </div>

                <button class="new-invoice-btn" onclick="saveProduct()">حفظ المنتج</button>
            </div>
        </div>
    </div>

    <!-- إضافة نافذة QR Code -->
    <div id="qrModal" class="modal">
        <div class="modal-content qr-modal">
            <span class="close" onclick="closeQRModal()">&times;</span>
            <h2>مشاركة التطبيق</h2>
            <div class="qr-container">
                <canvas id="qrCode"></canvas>
                <p>امسح الكود باستخدام كاميرا الهاتف للوصول إلى التطبيق</p>
                <div class="app-link">https://elmagicxp60.github.io/elmohaseb2/</div>
                <button class="share-btn" onclick="copyAppLink()">
                    <i class="fas fa-copy"></i>
                    نسخ الرابط
                </button>
            </div>
        </div>
    </div>


    <script>
        // المتغيرات الرئيسية
        let invoiceCounter = 1;
        let invoices = [];
        let products = [];
        let clients = [];
        let localData = {
            settings: {}
        };

        function showSection(sectionId) {
            // إخفاء جميع الأقسام
            const sections = document.getElementsByClassName('section-content');
            for (let section of sections) {
                section.classList.remove('active');
            }

            // إظهار القسم المحدد
            document.getElementById(sectionId).classList.add('active');

            // تحديث جدول الشحنات عند الانتقال إلى قسم الشحنات
            if (sectionId === 'shipping') {
                // إنشاء جدول الشحنات إذا لم يكن موجوداً
                const shipmentsSection = document.getElementById('shipping');
                if (!document.getElementById('shipmentsTable')) {
                    shipmentsSection.innerHTML = `
                <h2 class="section-title">قسم الشحنات</h2>
                <table id="shipmentsTable" class="invoice-table">
                    <thead>
                        <tr>
                            <th>رقم الفاتورة</th>
                            <th>التاريخ</th>
                            <th>اسم العميل</th>
                            <th>العنوان</th>
                            <th>الإجمالي</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            `;
                }
                updateShipmentsTable();
            }
        }


        // تعديل دالة toggleInvoiceForm
        function toggleInvoiceForm() {
            const modal = document.getElementById('invoiceModal');
            modal.style.display = 'block';

            // استخدام الدالة المحدثة لتوليد رقم الفاتورة
            document.getElementById('invoiceNumber').value = generateInvoiceNumber();
            document.getElementById('invoiceDate').value = new Date().toLocaleDateString('ar-EG');
            clearInvoiceForm();

            // إضافة مستمع حدث لتغيير المحافظة
            document.getElementById('governorate').addEventListener('change', function () {
                updateShippingCost(this.value);
            });

            // إعداد الاقتراحات لاسم العميل
            setupAutoComplete('customerName', clients, 'name', (client) => {
                if (client) {
                    document.getElementById('phone').value = client.phone;
                    document.getElementById('governorate').value = client.governorate;
                    document.getElementById('address').value = client.address;
                    updateShippingCost(client.governorate);
                }
            });
        }




        // دالة للحصول على آخر رقم فاتورة
        function getLastInvoiceNumber() {
            if (!invoices || invoices.length === 0) return 0;

            // البحث عن أكبر رقم فاتورة
            const lastNumber = invoices
                .map(inv => parseInt(inv.number.replace('#', '')))
                .reduce((max, current) => Math.max(max, current), 0);

            return lastNumber;
        }

        function closeInvoiceModal() {
            document.getElementById('invoiceModal').style.display = 'none';
        }

        function addInvoiceItem() {
            const tbody = document.getElementById('invoiceItems');
            const row = tbody.insertRow();
            const uniqueId = 'item_' + Date.now();

            row.innerHTML = `
                <td>
                    <div class="form-group" style="margin:0">
                        <input type="text" class="item-name" id="${uniqueId}" required>
                    </div>
                </td>
                <td><input type="number" class="item-price" onchange="calculateRowTotal(this)" required></td>
                <td><input type="number" class="item-quantity" onchange="calculateRowTotal(this)" required></td>
                <td><input type="number" class="item-total" readonly></td>
                <td><button class="delete-btn" onclick="deleteRow(this)">حذف</button></td>
            `;

            // إضافة الاقتراحات للمنتج
            const itemNameInput = row.querySelector('.item-name');
            setupAutoComplete(uniqueId, products, 'name', (product) => {
                if (product) {
                    const priceInput = row.querySelector('.item-price');
                    priceInput.value = product.sellPrice;
                    calculateRowTotal(priceInput);
                }
            });
        }

        function calculateRowTotal(input) {
            const row = input.parentElement.parentElement;
            const price = row.querySelector('.item-price').value || 0;
            const quantity = row.querySelector('.item-quantity').value || 0;
            const total = price * quantity;
            row.querySelector('.item-total').value = total;
            calculateInvoiceTotal();
        }




        // دالة تحديث قيمة التوصيل
        function updateShippingCost(governorate) {
            const shippingCostInput = document.getElementById('shippingCost');
            const deliveryInfo = document.querySelector('.delivery-info');

            console.log('تحديث قيمة التوصيل للمحافظة:', governorate); // للتأكد من تنفيذ الدالة
            console.log('أسعار الشحن المتوفرة:', shippingRates); // للتأكد من البيانات


            if (governorate && shippingRates[governorate]) {
                const rate = shippingRates[governorate];
                shippingCostInput.value = rate.price;
                deliveryInfo.textContent = `مدة التوصيل المتوقعة: ${rate.duration} يوم`;
                deliveryInfo.style.display = 'block';
            } else {
                shippingCostInput.value = 0;
                deliveryInfo.style.display = 'none';
            }

            calculateInvoiceTotal();
        }








        // تعديل دالة حساب الإجمالي لتشمل قيمة التوصيل
        function calculateInvoiceTotal() {
            // حساب إجمالي المنتجات فقط
            const totals = [...document.getElementsByClassName('item-total')];
            const productsTotal = totals.reduce((sum, input) => sum + (Number(input.value) || 0), 0);

            // عرض إجمالي المنتجات في حقل إجمالي الفاتورة
            document.getElementById('totalAmount').value = productsTotal;

            // إضافة قيمة التوصيل للإجمالي النهائي
            const shippingCost = Number(document.getElementById('shippingCost').value) || 0;
            const discount = Number(document.getElementById('discountAmount').value) || 0;

            // حساب الإجمالي النهائي (إجمالي المنتجات + قيمة التوصيل - الخصم)
            const finalTotal = (productsTotal + shippingCost) - discount;

            document.getElementById('finalTotalAmount').value = finalTotal >= 0 ? finalTotal : 0;
        }
        function deleteRow(button) {
            const row = button.parentElement.parentElement;
            row.remove();
            calculateInvoiceTotal();
        }







        function showInvoiceDetails(index) {
            const invoice = invoices[index];
            const detailsModal = document.createElement('div');
            detailsModal.className = 'modal';
            detailsModal.id = 'detailsModal';
            detailsModal.innerHTML = `
                <div class="modal-content receipt-style">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <div class="receipt-header">
<img src="https://i.postimg.cc/43cfrD4g/logo.jpg" alt="Farfasha Logo" style="max-width: 100%; height: auto;" />

                        <h2>فاتورة مبيعات</h2>
                        <h3> فرفشة ستور</h2>

                        <p>رقم الفاتورة: ${invoice.number}</p>
                        <p>التاريخ: ${invoice.date}</p>
                    </div>
                    <div class="receipt-customer">
                        <p><strong>العميل:</strong> ${invoice.customer}</p>
                        <p><strong>الهاتف:</strong> ${invoice.phone}</p>
                        <p><strong>المحافظة:</strong> ${invoice.governorate}</p>
                        <p><strong>العنوان:</strong> ${invoice.address}</p>
                    </div>
                    <table class="receipt-items">
                        <thead>
                            <tr>
                                <th>الصنف</th>
                                <th>الكمية</th>
                                <th>السعر</th>
                                <th>الإجمالي</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoice.items.map(item => `
                                <tr>
                                    <td>${item.name}</td>
                                    <td>${item.quantity}</td>
                                    <td>${item.price} ج.م</td>
                                    <td>${item.total} ج.م</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="receipt-total">
                        <strong>الإجمالي : ${invoice.total} ج.م</strong>
                        <br>
                        <strong>الخصم: ${invoice.discount || 0} ج.م</strong>
                        <br>
                         <strong>قيمة التوصيل: ${invoice.shippingCost || 0} ج.م</strong>
                        <br>
                        <strong>الإجمالي الكلي: ${invoice.finalTotal || invoice.total} ج.م</strong>
                    </div>
                    <div class="receipt-footer">
                        <p>شكراً لتعاملكم معنا</p>
                        <p>نتمنى لكم تجربة تسوق سعيدة مع فرفشة 🌹</p>
                        <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
                            <button class="new-invoice-btn" onclick="editInvoice(${index})" style="background: #3498db;">
                                تعديل الفاتورة
                            </button>
                            <button class="new-invoice-btn" onclick="printReceipt()" style="background: #2ecc71;">
                                طباعة
                            </button>
                            <button class="new-invoice-btn" onclick="shareOnWhatsApp(${index})" style="background: #25D366;">
                                <i class="fab fa-whatsapp"></i> مشاركة واتساب
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(detailsModal);
            detailsModal.style.display = 'block';

            // إضافة مستمع حدث للنقر
    detailsModal.addEventListener('click', (event) => {
        // إذا تم النقر على الخلفية وليس على المحتوى
        if (event.target === detailsModal) {
            detailsModal.remove();
        }
    });




        }

        function printReceipt() {
            const receiptContent = document.querySelector('.receipt-style').cloneNode(true);
            // إخفاء أزرار التعديل والطباعة
            const actionButtons = receiptContent.querySelector('.receipt-footer div');
            if (actionButtons) {
                actionButtons.style.display = 'none';
            }

            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>طباعة الفاتورة</title>');
            printWindow.document.write(`<style>
                ${document.querySelector('style').innerHTML}
            </style>`);
            printWindow.document.write('</head><body>');
            printWindow.document.write(receiptContent.outerHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();


            // انتظر تحميل الصورة قبل الطباعة
            const logoImg = printWindow.document.querySelector('.receipt-header img');
            logoImg.onload = function () {
                printWindow.print();
            };
        }

        function deleteInvoice(index) {
            if (confirm('هل أنت متأكد من حذف هذه الفاتورة؟')) {
                invoices.splice(index, 1);

                // حفظ في Firebase
                firebaseHelper.saveData('invoices', invoices)
                    .then(() => {
                        updateInvoicesTable();
                    })
                    .catch(error => {
                        console.error('خطأ في حذف الفاتورة:', error);
                    });
            }
        }

        function shipInvoice(index) {
            const invoice = invoices[index];
            invoice.shipped = true;
            invoice.status = 'pending';
            invoice.paid = false;

            // حفظ في Firebase
            firebaseHelper.saveData('invoices', invoices)
                .then(() => {
                    // إضافة إشعار للشحنة الجديدة
                    addNotification(
                        'شحنة جديدة',
                        `تم إضافة شحنة جديدة للفاتورة ${invoice.number} - العميل: ${invoice.customer}`,
                        'info'
                    );

                    // تحديث الجداول
                    updateShipmentsTable();
                    updateInvoicesTable();
                })
                .catch(error => {
                    console.error('خطأ في تحديث حالة الشحن:', error);
                    addNotification(
                        'خطأ',
                        'حدث خطأ أثناء شحن الفاتورة',
                        'error'
                    );
                });
        }







        function editInvoice(index) {
            const invoice = invoices[index];
            const detailsModal = document.getElementById('detailsModal');

            if (detailsModal) {
                detailsModal.remove();
            }

            const invoiceModal = document.getElementById('invoiceModal');
            invoiceModal.style.display = 'block';
            invoiceModal.dataset.editIndex = index;

            // تعبئة البيانات الأساسية
            document.getElementById('invoiceNumber').value = invoice.number;
            document.getElementById('invoiceDate').value = invoice.date;
            document.getElementById('customerName').value = invoice.customer;
            document.getElementById('phone').value = invoice.phone;
            document.getElementById('governorate').value = invoice.governorate;
            document.getElementById('address').value = invoice.address;

            // تحديث قيمة التوصيل
            if (invoice.governorate) {
                updateShippingCost(invoice.governorate);
            }

            // تفريغ وإعادة ملء جدول المنتجات
            const invoiceItems = document.getElementById('invoiceItems');
            invoiceItems.innerHTML = '';

            invoice.items.forEach(item => {
                const uniqueId = 'item_' + Date.now() + Math.random().toString(36).substr(2, 9);
                const row = invoiceItems.insertRow();
                row.innerHTML = `
            <td>
                <div class="form-group" style="margin:0">
                    <input type="text" class="item-name" id="${uniqueId}" value="${item.name}" required>
                </div>
            </td>
            <td><input type="number" class="item-price" value="${item.price}" onchange="calculateRowTotal(this)" required></td>
            <td><input type="number" class="item-quantity" value="${item.quantity}" onchange="calculateRowTotal(this)" required></td>
            <td><input type="number" class="item-total" value="${item.total}" readonly></td>
            <td><button class="delete-btn" onclick="deleteRow(this)">حذف</button></td>
        `;

                // إضافة الاقتراحات للمنتج
                setupAutoComplete(uniqueId, products, 'name', (product) => {
                    if (product) {
                        const priceInput = row.querySelector('.item-price');
                        priceInput.value = product.sellPrice;
                        calculateRowTotal(priceInput);
                    }
                });
            });

            // تحديث الإجمالي والخصم والإجمالي النهائي
            document.getElementById('totalAmount').value = invoice.total;
            document.getElementById('discountAmount').value = invoice.discount || 0;
            document.getElementById('shippingCost').value = invoice.shippingCost || 0;
            document.getElementById('finalTotalAmount').value = invoice.finalTotal || invoice.total;

            // إضافة مستمع حدث لتغيير المحافظة
            document.getElementById('governorate').addEventListener('change', function () {
                updateShippingCost(this.value);
            });
        }

        // تعديل دالة إنشاء رقم الفاتورة
        function generateInvoiceNumber() {
            const lastNumber = getLastInvoiceNumber();
            const newNumber = lastNumber + 1;
            return `#${String(newNumber).padStart(4, '0')}`;
        }

        function clearInvoiceForm() {
            document.getElementById('customerName').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('governorate').value = '';
            document.getElementById('address').value = '';
            document.getElementById('invoiceItems').innerHTML = '';
            document.getElementById('totalAmount').value = '';
            document.getElementById('discountAmount').value = '0';
            document.getElementById('finalTotalAmount').value = '';

            // تفريغ قيمة التوصيل
            document.getElementById('shippingCost').value = '0';
            // إخفاء معلومات مدة التوصيل
            document.querySelector('.delivery-info').style.display = 'none';

            addInvoiceItem();
        }

        function saveInvoice() {
            alert('تم حفظ الفاتورة بنجاح');
            toggleInvoiceForm();
        }

        /*************  ✨ Codeium Command ⭐  *************/
        /**
         * Display the new product form modal and clear any existing values.
         * This is used when the user clicks the "Add Product" button.
         */
        /******  ef4f5623-1164-45ae-b4a7-de9af82a3999  *******/
        function showNewProductForm() {
            const modal = document.getElementById('productModal');
            modal.style.display = 'block';
            clearProductForm();
        }

        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
        }

        function previewImage(input) {
            const preview = document.getElementById('imagePreview');
            const removeBtn = document.querySelector('.remove-image-btn');
            const file = input.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    removeBtn.style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        }

        function removeImage() {
            const preview = document.getElementById('imagePreview');
            const input = document.getElementById('productImage');
            const removeBtn = document.querySelector('.remove-image-btn');

            preview.src = '';
            preview.style.display = 'none';
            input.value = '';
            removeBtn.style.display = 'none';
        }


        function clearProductForm() {
            document.getElementById('productName').value = '';
            document.getElementById('buyPrice').value = '';
            document.getElementById('sellPrice').value = '';
            document.getElementById('quantity').value = '';
            document.getElementById('imagePreview').src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDE1MCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjE1MCIgaGVpZ2h0PSIxNTAiIGZpbGw9IiNFNUU1RTUiLz48dGV4dCB4PSI3NSIgeT0iNzUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiM2NjY2NjYiPtis2YjYsdipINin2YHYqtix2KfYttmK2Kk8L3RleHQ+PC9zdmc+';

            const modal = document.getElementById('productModal');
            if (modal && modal.dataset.editingId) {
                delete modal.dataset.editingId; // إزالة معرف التعديل
            }

            const removeBtn = document.querySelector('.remove-image-btn');
            if (removeBtn) {
                removeBtn.style.display = 'none';
            }
        }


        function showProductImage(imageSrc) {
            const modal = document.createElement('div');
            modal.className = 'large-image-modal';
            modal.innerHTML = `<img src="${imageSrc}" class="large-image">`;
            modal.onclick = () => modal.remove();
            document.body.appendChild(modal);
            modal.style.display = 'block';
        }



        function deleteProduct(id) {
            if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
                // تحويل المعرف إلى رقم للمقارنة
                const productId = parseInt(id);

                // فلترة المنتجات لحذف المنتج المحدد
                products = products.filter(p => p.id !== productId);

                // حفظ في Firebase
                firebaseHelper.saveData('products', products)
                    .then(() => {
                        // تحديث قائمة المنتجات
                        updateProductsList();
                        // إضافة إشعار نجاح
                        addNotification(
                            'حذف منتج',
                            'تم حذف المنتج بنجاح',
                            'success'
                        );
                    })
                    .catch(error => {
                        console.error('خطأ في حذف المنتج:', error);
                        // إضافة إشعار خطأ
                        addNotification(
                            'خطأ',
                            'حدث خطأ أثناء حذف المنتج',
                            'error'
                        );
                    });
            }
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (product) {
                document.getElementById('productModal').dataset.editingId = id;
                showNewProductForm();

                document.getElementById('productName').value = product.name;
                document.getElementById('buyPrice').value = product.buyPrice;
                document.getElementById('sellPrice').value = product.sellPrice;
                document.getElementById('quantity').value = product.quantity;

                if (product.image) {
                    document.getElementById('imagePreview').src = product.image;
                    document.getElementById('imagePreview').style.display = 'block';
                    document.querySelector('.remove-image-btn').style.display = 'block';
                }
            }
        }

        function showNewClientForm() {
            const modal = document.getElementById('clientModal');
            modal.style.display = 'block';
            clearClientForm();
        }

        function closeClientModal() {
            document.getElementById('clientModal').style.display = 'none';
        }

        function clearClientForm() {
            document.getElementById('clientName').value = '';
            document.getElementById('clientGovernorate').value = '';
            document.getElementById('clientPhone').value = '';
            document.getElementById('clientAddress').value = '';
        }

        function saveClient() {
            const clientName = document.getElementById('clientName').value;
            const governorate = document.getElementById('clientGovernorate').value;
            const phone = document.getElementById('clientPhone').value;
            const address = document.getElementById('clientAddress').value;

            if (!clientName || !governorate || !phone || !address) {
                alert('يرجى ملء جميع الحقول المطلوبة');
                return;
            }

            const editingId = document.getElementById('clientModal').dataset.editingId;

            const clientData = {
                id: editingId ? Number(editingId) : Date.now(),
                name: clientName,
                governorate: governorate,
                phone: phone,
                address: address
            };

            if (editingId) {
                // تحديث العميل الموجود
                const index = clients.findIndex(c => c.id === Number(editingId));
                if (index !== -1) {
                    clients[index] = clientData;
                }
                document.getElementById('clientModal').dataset.editingId = '';
            } else {
                // إضافة عميل جديد
                clients.push(clientData);
            }

            // حفظ في Firebase
            firebaseHelper.saveData('clients', clients)
                .then(() => {

                    updateClientsList();
                    clearClientForm();
                    closeClientModal();
                    // الانتقال إلى قسم العملاء
                    showSection('clients');
                    updateClientsList();
                    // تمييز العميل الجديد (اختياري)
                    const clientRow = document.querySelector(`tr[data-client-name="${clientName}"]`);
                    if (clientRow) {
                        clientRow.classList.add('highlight-row');
                        setTimeout(() => {
                            clientRow.classList.remove('highlight-row');
                        }, 6000);
                    }
                })
                .catch(error => {
                    console.error('خطأ في حفظ العميل:', error);
                    alert('حدث خطأ في حفظ العميل');
                });
        }

        function updateClientsList() {
            const clientsSection = document.getElementById('clients');
            if (!document.getElementById('clientsTable')) {
                clientsSection.innerHTML += `
                <table id="clientsTable" class="invoice-table">
                    <thead>
                        <tr>
                            <th>اسم العميل</th>
                            <th>المحافظة</th>
                            <th>رقم الهاتف</th>
                            <th>العنوان</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                <div id="clientsTable-pagination" class="pagination-controls"></div>
            `;
            }

            // تخزين البيانات في متغير عالمي
            window.clientsTableData = clients.map(client => `
            <tr>
                <td>${client.name}</td>
                <td>${client.governorate}</td>
                <td>${client.phone}</td>
                <td>${client.address}</td>
                <td>
                    <button class="action-btn details-btn" onclick="editClient(${client.id})">تعديل</button>
                    <button class="action-btn delete-invoice-btn" onclick="deleteClient(${client.id})">حذف</button>
                </td>
            </tr>
        `);

            // عرض الصفحة الأولى
            paginateTable('clientsTable', window.clientsTableData, 15, 1);
        }

        function deleteClient(id) {
            if (confirm('هل أنت متأكد من حذف هذا العميل؟')) {
                clients = clients.filter(c => c.id !== id);

                // حفظ في Firebase
                firebaseHelper.saveData('clients', clients)
                    .then(() => {
                        updateClientsList();
                    })
                    .catch(error => {
                        console.error('خطأ في حذف العميل:', error);
                    });
            }
        }

        function editClient(id) {
            const client = clients.find(c => c.id === id);
            if (client) {
                document.getElementById('clientModal').dataset.editingId = id;
                showNewClientForm();

                document.getElementById('clientName').value = client.name;
                document.getElementById('clientGovernorate').value = client.governorate;
                document.getElementById('clientPhone').value = client.phone;
                document.getElementById('clientAddress').value = client.address;
            }
        }

        function setupAutoComplete(inputId, items, property, onSelect) {
            const input = document.getElementById(inputId);
            if (!input) return;

            // إزالة أي قائمة اقتراحات سابقة
            const oldSuggestions = input.parentElement.querySelector('.suggestions');
            if (oldSuggestions) {
                oldSuggestions.remove();
            }

            const suggestionsDiv = document.createElement('div');
            suggestionsDiv.className = 'suggestions';
            input.parentElement.appendChild(suggestionsDiv);

            input.addEventListener('input', function () {
                const value = this.value.trim().toLowerCase();
                if (!value) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }

                const matches = items.filter(item =>
                    item && item[property] &&
                    item[property].toString().toLowerCase().includes(value)
                );

                if (matches.length > 0) {
                    suggestionsDiv.innerHTML = matches
                        .map(item => `<div class="suggestion-item">${item[property]}</div>`)
                        .join('');
                    suggestionsDiv.style.display = 'block';

                    const suggestionItems = suggestionsDiv.getElementsByClassName('suggestion-item');
                    Array.from(suggestionItems).forEach(item => {
                        item.addEventListener('click', function () {
                            input.value = this.textContent;
                            suggestionsDiv.style.display = 'none';
                            if (onSelect) {
                                const selectedItem = matches.find(m =>
                                    m[property].toString() === this.textContent
                                );
                                onSelect(selectedItem);
                            }
                        });
                    });
                } else {
                    suggestionsDiv.style.display = 'none';
                }
            });

            // تحسين تجربة المستخدم
            input.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    suggestionsDiv.style.display = 'none';
                }
            });

            document.addEventListener('click', function (e) {
                if (!input.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                    suggestionsDiv.style.display = 'none';
                }
            });
        }

        // الرابط الثابت للتطبيق
        const APP_URL = "https://elmagicxp60.github.io/elmohaseb2/";

        function generateQRCode() {
            const modal = document.getElementById('qrModal');

            // تحديث محتوى النافذة المنبثقة
            const modalContent = modal.querySelector('.modal-content');
            modalContent.innerHTML = `
        <span class="close" onclick="closeQRModal()">&times;</span>
        <h2>مشاركة التطبيق</h2>
        <div class="qr-container">
            <canvas id="qrCode"></canvas>
            <p>امسح الكود باستخدام كاميرا الهاتف للوصول إلى التطبيق</p>
            <div class="app-link">${APP_URL}</div>
            <button class="share-btn" onclick="copyAppLink()">
                <i class="fas fa-copy"></i>
                نسخ الرابط
            </button>
        </div>
    `;

            // إنشاء QR Code
            const qr = new QRious({
                element: document.getElementById('qrCode'),
                value: APP_URL,
                size: 256,
                backgroundAlpha: 1,
                foreground: '#2c3e50',
                level: 'H'
            });

            modal.style.display = 'block';
        }

        function copyAppLink() {
            navigator.clipboard.writeText(APP_URL).then(() => {
                const notification = document.createElement('div');
                notification.className = 'copy-success';
                notification.textContent = 'تم نسخ الرابط بنجاح!';
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 2000);
            }).catch(err => {
                console.error('فشل في نسخ الرابط: ', err);
                alert('حدث خطأ أثناء نسخ الرابط');
            });
        }

        function shareViaWhatsApp() {
            const whatsappURL = `https://wa.me/?text=${encodeURIComponent('تطبيق المحاسبة البسيط: ' + APP_URL)}`;
            window.open(whatsappURL);
        }


        function closeQRModal() {
            document.getElementById('qrModal').style.display = 'none';
        }

        function shareOnWhatsApp(index) {
            const invoice = invoices[index];
            const receiptElement = document.querySelector('.receipt-style').cloneNode(true);

            // إخفاء الأزرار
            const actionButtons = receiptElement.querySelector('.receipt-footer div');
            if (actionButtons) {
                actionButtons.style.display = 'none';
            }

            // إضافة الريسيت مؤقتاً للصفحة
            receiptElement.style.position = 'fixed';
            receiptElement.style.left = '-9999px';
            document.body.appendChild(receiptElement);

            // التأكد من تحميل الصورة قبل التحويل
            const logoImg = receiptElement.querySelector('.receipt-header img');

            // وعد لتحميل الصورة
            const loadImage = new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    logoImg.src = img.src;
                    resolve();
                };
                img.src = "https://i.postimg.cc/43cfrD4g/logo.jpg";
            });

            // انتظار تحميل الصورة ثم تحويل الريسيت إلى صورة
            loadImage.then(() => {
                setTimeout(() => { // إضافة تأخير صغير للتأكد من تطبيق كل التغييرات
                    html2canvas(receiptElement, {
                        scale: 2,
                        backgroundColor: '#ffffff',
                        logging: false,
                        useCORS: true, // السماح بتحميل الصور من مصادر خارجية
                        allowTaint: true // السماح بتحميل الصور من مصادر خارجية
                    }).then(canvas => {
                        // إزالة العنصر المؤقت
                        document.body.removeChild(receiptElement);

                        // تحويل الصورة إلى Base64 بجودة عالية
                        const image = canvas.toDataURL('image/jpeg', 1.0);

                        // تحميل الصورة للجهاز
                        const downloadLink = document.createElement('a');
                        downloadLink.download = `invoice-${invoice.number}.jpg`;
                        downloadLink.href = image;
                        downloadLink.click();

                        // مشاركة عبر واتساب
                        const phoneNumber = invoice.phone.replace(/\D/g, '');
                        const whatsappURL = `https://wa.me/${phoneNumber}`;
                        window.open(whatsappURL);
                    });
                }, 500);
            });
        }

        // تحميل البيانات عند بدء التطبيق
        document.addEventListener('DOMContentLoaded', () => {
            showSection('invoices');
        });

        function updateShipmentsTable() {
            const shipmentsSection = document.getElementById('shipping');

            // إنشاء جدول الشحنات إذا لم يكن موجوداً
            if (!document.getElementById('shipmentsTable')) {
                shipmentsSection.innerHTML = `
            <h2 class="section-title">قسم الشحنات</h2>
            <table id="shipmentsTable" class="invoice-table">
                <thead>
                    <tr>
                        <th>رقم الفاتورة</th>
                        <th>التاريخ</th>
                        <th>اسم العميل</th>
                        <th>العنوان</th>
                        <th>الإجمالي</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div id="shipmentsTable-pagination" class="pagination-controls"></div>
        `;
            }

            // تحديث البيانات العالمية للشحنات
            window.shipmentsTableData = invoices
                .filter(inv => inv.shipped)
                .map(inv => `
        <tr class="${getShipmentRowClass(inv)}" 
            data-invoice-number="${inv.number}"
            data-customer-name="${inv.customer}">
            <td>${inv.number}</td>
            <td>${inv.date}</td>
            <td>${inv.customer}</td>
            <td>${inv.address}</td>
            <td>${inv.total}</td>
           <td>
                    <select class="status-dropdown" onchange="updateShipmentStatus(${invoices.indexOf(inv)}, this.value)">
                        <option value="pending" ${inv.status === 'pending' ? 'selected' : ''}>قيد التسليم</option>
                        <option value="delivered" ${inv.status === 'delivered' ? 'selected' : ''}>تم التسليم</option>
                        <option value="cancelled" ${inv.status === 'cancelled' ? 'selected' : ''}>إلغاء</option>
                        <option value="returned" ${inv.status === 'returned' ? 'selected' : ''}>مرتجع</option>
                        <option value="paid" ${inv.paid ? 'selected' : ''}>مدفوع</option>
                    </select>
                    <button class="action-btn details-btn" onclick="showInvoiceDetails(${invoices.indexOf(inv)})" title="تفاصيل">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
        </tr>
    `);

            // عرض الصفحة الأولى باستخدام الدالة المحسنة
            paginateShipmentsTable(1);
        }








        function paginateShipmentsTable(pageNumber) {
            const shipmentsPerPage = 10;
            const tableBody = document.querySelector('#shipmentsTable tbody');
            const totalPages = Math.ceil(window.shipmentsTableData.length / shipmentsPerPage);

            // التأكد من أن رقم الصفحة صالح
            if (pageNumber < 1) pageNumber = 1;
            if (pageNumber > totalPages) pageNumber = totalPages;

            const start = (pageNumber - 1) * shipmentsPerPage;
            const end = start + shipmentsPerPage;

            // تحديث محتوى الجدول
            if (tableBody && window.shipmentsTableData) {
                tableBody.innerHTML = window.shipmentsTableData.slice(start, end).join('');
            }

            // تحديث أزرار التنقل
            const paginationDiv = document.querySelector('#shipmentsTable-pagination');
            if (paginationDiv) {
                paginationDiv.innerHTML = `
            <button onclick="paginateShipmentsTable(${pageNumber - 1})" 
                    ${pageNumber === 1 ? 'disabled' : ''}>
                السابق
            </button>
            <span>صفحة ${pageNumber} من ${totalPages}</span>
            <button onclick="paginateShipmentsTable(${pageNumber + 1})" 
                    ${pageNumber === totalPages ? 'disabled' : ''}>
                التالي
            </button>
        `;
            }
        }

        function updateShipmentsPaginationControls(currentPage, totalPages) {
            const paginationDiv = document.getElementById('shipmentsPagination');
            if (!paginationDiv) return;

            paginationDiv.innerHTML = `
        <button onclick="paginateShipments(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>السابق</button>
        <span>صفحة ${currentPage} من ${totalPages}</span>
        <button onclick="paginateShipments(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>التالي</button>
    `;
        }







        function getShipmentRowClass(invoice) {
            if (invoice.status === 'cancelled') return 'shipping-row-cancelled';
            if (invoice.status === 'returned') return 'shipping-row-returned';
            if (invoice.paid) return 'shipping-row-paid';
            return '';
        }

        function updateShipmentStatus(index, status) {
            const invoice = invoices[index];
            let notificationMessage = '';

            // تحديث حالة الفاتورة
            if (status === 'paid') {
                invoice.paid = true;
                // لا نغير status هنا
                notificationMessage = `تم تأكيد دفع شحنة الفاتورة ${invoice.number}`;
            } else {
                invoice.status = status;
                invoice.paid = false;

                switch (status) {
                    case 'delivered':
                        notificationMessage = `تم تسليم شحنة الفاتورة ${invoice.number}`;
                        break;
                    case 'cancelled':
                        notificationMessage = `تم إلغاء شحنة الفاتورة ${invoice.number}`;
                        break;
                    case 'returned':
                        notificationMessage = `تم إرجاع شحنة الفاتورة ${invoice.number}`;
                        break;
                    default:
                        notificationMessage = `تم تحديث حالة شحنة الفاتورة ${invoice.number}`;
                }
            }

            // حفظ في Firebase وتحديث الواجهة
            firebaseHelper.saveData('invoices', invoices)
                .then(() => {
                    // تحديث كلا الجدولين
                    updateShipmentsTable();
                    updateInvoicesTable();

                    // إضافة إشعار
                    addNotification(
                        'تحديث حالة الشحنة',
                        notificationMessage,
                        'info'
                    );

                    // تمييز الصف المحدث في كلا الجدولين
                    setTimeout(() => {
                        // تمييز في جدول الشحنات
                        const shipmentRow = document.querySelector(`#shipmentsTable tr[data-invoice-number="${invoice.number}"]`);
                        if (shipmentRow) {
                            shipmentRow.classList.add('highlight-row');
                            setTimeout(() => shipmentRow.classList.remove('highlight-row'), 6000);
                        }

                        // تمييز في جدول الفواتير
                        const invoiceRow = document.querySelector(`#invoicesTable tr[data-invoice-number="${invoice.number}"]`);
                        if (invoiceRow) {
                            invoiceRow.classList.add('highlight-row');
                            setTimeout(() => invoiceRow.classList.remove('highlight-row'), 6000);
                        }
                    }, 100);
                })
                .catch(error => {
                    console.error('خطأ في تحديث حالة الشحن:', error);
                    addNotification(
                        'خطأ',
                        'حدث خطأ في تحديث حالة الشحنة',
                        'error'
                    );
                });
        }

        // تعديل دالة updateInvoicesTable لتضيف مربع البحث في بداية الجدول
        function updateInvoicesTable() {
            const invoicesSection = document.getElementById('invoices');

            // إضافة مربع البحث وزر إنشاء فاتورة جديدة
            if (!document.querySelector('.invoice-controls')) {
                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'invoice-controls';
                controlsDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;';
                controlsDiv.innerHTML = `
            <button class="new-invoice-btn" onclick="toggleInvoiceForm()">إنشاء فاتورة جديدة</button>
            <div class="search-box">
                <input type="text" id="invoiceSearch" placeholder="البحث برقم الفاتورة أو اسم العميل" class="search-input">
                <i class="fas fa-search search-icon"></i>
            </div>
        `;

                const titleElement = invoicesSection.querySelector('.section-title');
                titleElement.insertAdjacentElement('afterend', controlsDiv);
            }

            // إنشاء جدول الفواتير وعناصر التنقل
            if (!document.getElementById('invoicesTable')) {
                invoicesSection.innerHTML += `
            <table id="invoicesTable" class="invoice-table">
                <thead>
                    <tr>
                        <th>رقم الفاتورة</th>
                        <th>التاريخ</th>
                        <th>اسم العميل</th>
                        <th>الإجمالي</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div id="invoicesPagination" style="margin-top: 20px; text-align: center;"></div>
        `;
            }

            // عرض الصفحة الأولى من الفواتير
            paginateInvoices(1);

            // إضافة وظيفة البحث
            setupInvoiceSearch();
        }







        // دالة البحث المحسنة
        function setupInvoiceSearch() {
            const searchInput = document.getElementById('invoiceSearch');
            if (!searchInput) return;

            searchInput.addEventListener('input', function () {
                const searchTerm = this.value.toLowerCase().trim();
                const rows = document.querySelectorAll('#invoicesTable tbody tr');

                rows.forEach(row => {
                    const invoiceNumber = row.getAttribute('data-invoice-number').toLowerCase();
                    const customerName = row.getAttribute('data-customer-name').toLowerCase();

                    if (invoiceNumber.includes(searchTerm) || customerName.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        }








        // دالة لتقسيم الصفحات
        // تعديل دالة paginateInvoices لإضافة عمود الحالة
function paginateInvoices(pageNumber) {
    const invoicesPerPage = 10;
    const tbody = document.getElementById('invoicesTable').querySelector('tbody');
    const totalPages = Math.ceil(invoices.length / invoicesPerPage);
    const start = (pageNumber - 1) * invoicesPerPage;
    const end = start + invoicesPerPage;

    // تعديل header الجدول لإضافة عمود الحالة
    const thead = document.getElementById('invoicesTable').querySelector('thead');
    thead.innerHTML = `
        <tr>
            <th>رقم الفاتورة</th>
            <th>التاريخ</th>
            <th>اسم العميل</th>
            <th>الإجمالي</th>
            <th>الحالة</th>
            <th>الإجراءات</th>
        </tr>
    `;

    // عرض الفواتير للصفحة الحالية مع إضافة خانة الحالة
    tbody.innerHTML = invoices.slice(start, end).map((inv, index) => `
        <tr class="${inv.shipped ? 'shipped' : ''}" 
            data-invoice-number="${inv.number}" 
            data-customer-name="${inv.customer}">
            <td>${inv.number}</td>
            <td>${inv.date}</td>
            <td>${inv.customer}</td>
            <td>${inv.total}</td>
            <td>
                <span class="status-badge ${getInvoiceStatusClass(inv)}">
                    ${getInvoiceStatusText(inv)}
                </span>
            </td>
            <td>
                <button class="action-btn details-btn" onclick="showInvoiceDetails(${start + index})" title="عرض التفاصيل">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="action-btn edit-btn" onclick="editInvoice(${start + index})" title="تعديل">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn delete-invoice-btn" onclick="deleteInvoice(${start + index})" title="حذف">
                    <i class="fas fa-trash"></i>
                </button>
                <button class="action-btn ship-btn" onclick="shipInvoice(${start + index})" 
                    ${inv.shipped ? 'disabled' : ''} 
                    title="${inv.shipped ? 'تم الشحن' : 'شحن'}">
                    <i class="fas fa-truck${inv.shipped ? '-loading' : ''}"></i>
                </button>
            </td>
        </tr>
    `).join('');

    updatePaginationControls(pageNumber, totalPages);
}








 // تحديث دالة getInvoiceStatusText
function getInvoiceStatusText(invoice) {
    if (!invoice.shipped) return 'جديدة';
    if (invoice.status === 'delivered') return 'تم التسليم';
    if (invoice.status === 'cancelled') return 'ملغاة';
    if (invoice.status === 'returned') return 'مرتجعة';
    if (invoice.paid) return 'مدفوعة';
    return 'قيد التسليم';
}

        // تحديث دالة getInvoiceStatusClass
function getInvoiceStatusClass(invoice) {
    if (!invoice.shipped) return 'status-pending';
    if (invoice.status === 'delivered') return 'status-delivered';
    if (invoice.status === 'cancelled') return 'status-cancelled';
    if (invoice.status === 'returned') return 'status-returned';
    if (invoice.paid) return 'status-paid';
    return 'status-pending';
}







        // دالة لتحديث أزرار التنقل
        function updatePaginationControls(currentPage, totalPages) {
            const paginationDiv = document.getElementById('invoicesPagination');
            paginationDiv.innerHTML = `
        <button onclick="paginateInvoices(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>السابق</button>
        <span>صفحة ${currentPage} من ${totalPages}</span>
        <button onclick="paginateInvoices(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>التالي</button>
    `;
        }








        // تعديل دالة updateProductsList لإضافة مربع البحث

        function updateProductsList() {
            const productsSection = document.getElementById('products');

            // إضافة مربع البحث وزر إضافة منتج جديد
            if (!document.querySelector('.products-controls')) {
                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'products-controls';
                controlsDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;';
                controlsDiv.innerHTML = `
            <button class="new-invoice-btn" onclick="showNewProductForm()">إضافة منتج جديد</button>
            <div class="search-box">
                <input type="text" id="productSearch" placeholder="البحث باسم المنتج" class="search-input">
                <i class="fas fa-search search-icon"></i>
            </div>
        `;

                const titleElement = productsSection.querySelector('.section-title');
                titleElement.insertAdjacentElement('afterend', controlsDiv);
            }

            // إنشاء جدول المنتجات وعناصر التنقل
            const productsList = document.getElementById('productsList');
            productsList.innerHTML = `
        <table id="productsTable" class="invoice-table">
            <thead>
                <tr>
                    <th>الصورة</th>
                    <th>اسم المنتج</th>
                    <th>سعر الشراء</th>
                    <th>سعر البيع</th>
                    <th>الكمية</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div id="productsPagination" style="margin-top: 20px; text-align: center;"></div>
    `;

            // عرض الصفحة الأولى من المنتجات
            
            paginateProducts(1);

            // إضافة وظيفة البحث
            setupProductSearch();
        }

        function paginateProducts(pageNumber) {
            const productsPerPage = 10;
            const tbody = document.getElementById('productsTable').querySelector('tbody');
            const totalPages = Math.ceil(products.length / productsPerPage);
            const start = (pageNumber - 1) * productsPerPage;
            const end = start + productsPerPage;

            const defaultImage = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDE1MCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjE1MCIgaGVpZ2h0PSIxNTAiIGZpbGw9IiNFNUU1RTUiLz48dGV4dCB4PSI3NSIgeT0iNzUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiM2NjY2NjYiPtis2YjYsdipINin2YHYqtix2KfYttmK2Kk8L3RleHQ+PC9zdmc+';



            tbody.innerHTML = products.slice(start, end).map(product => `
        <tr data-product-name="${product.name}">
            <td>
                <img src="${product.image}" 
                     style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px; cursor: pointer;"
                     onclick="showProductImage('${product.image}')"
                     onerror="this.src='${defaultImage}'"
                     title="انقر لتكبير الصورة">
                     
            </td>
            <td>${product.name}</td>
            <td>${product.buyPrice}</td>
            <td>${product.sellPrice}</td>
            <td>${product.quantity}</td>
            <td>
                <button class="action-btn edit-btn" onclick="editProduct(${product.id})" title="تعديل">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn delete-invoice-btn" onclick="deleteProduct(${product.id})" title="حذف">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');

            updateProductsPaginationControls(pageNumber, totalPages);
        }

        function updateProductsPaginationControls(currentPage, totalPages) {
            const paginationDiv = document.getElementById('productsPagination');
            if (!paginationDiv) return;

            paginationDiv.innerHTML = `
        <button onclick="paginateProducts(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>السابق</button>
        <span>صفحة ${currentPage} من ${totalPages}</span>
        <button onclick="paginateProducts(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>التالي</button>
    `;
        }







        // دالة البحث في المنتجات
        function setupProductSearch() {
            const searchInput = document.getElementById('productSearch');
            if (!searchInput) return;

            searchInput.addEventListener('input', function () {
                const searchTerm = this.value.toLowerCase().trim();
                const rows = document.querySelectorAll('#productsTable tbody tr');

                rows.forEach(row => {
                    const productName = row.getAttribute('data-product-name').toLowerCase();

                    if (productName.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        }






        // دالة البحث في المنتجات
        function setupProductSearch() {
            const searchInput = document.getElementById('productSearch');
            if (!searchInput) return;

            searchInput.addEventListener('input', function () {
                const searchTerm = this.value.toLowerCase().trim();
                const rows = document.querySelectorAll('#productsTable tbody tr');

                rows.forEach(row => {
                    const productName = row.getAttribute('data-product-name').toLowerCase();

                    if (productName.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        }

        // تعديل دالة updateClientsList لإضافة مربع البحث
        function updateClientsList() {
            const clientsSection = document.getElementById('clients');

            // إضافة مربع البحث وزر إضافة عميل جديد
            if (!document.querySelector('.clients-controls')) {
                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'clients-controls';
                controlsDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;';
                controlsDiv.innerHTML = `
            <button class="new-invoice-btn" onclick="showNewClientForm()">إضافة عميل جديد</button>
            <div class="search-box">
                <input type="text" id="clientSearch" placeholder="البحث باسم العميل أو رقم الهاتف" class="search-input">
                <i class="fas fa-search search-icon"></i>
            </div>
        `;

                // إضافة عناصر التحكم بعد العنوان
                const titleElement = clientsSection.querySelector('.section-title');
                titleElement.insertAdjacentElement('afterend', controlsDiv);
            }

            // إنشاء جدول العملاء
            const clientsList = document.getElementById('clientsList');
            clientsList.innerHTML = `
        <table id="clientsTable" class="invoice-table">
            <thead>
                <tr>
                    <th>اسم العميل</th>
                    <th>المحافظة</th>
                    <th>رقم الهاتف</th>
                    <th>العنوان</th>
                    <th>الإجراءات</th>
                </tr>
            </thead>
            <tbody>
                ${clients.map(client => `
                    <tr data-client-name="${client.name}" data-client-phone="${client.phone}">
                        <td>${client.name}</td>
                        <td>${client.governorate}</td>
                        <td>${client.phone}</td>
                        <td>${client.address}</td>
                        <td>
                            <button class="action-btn details-btn" onclick="editClient(${client.id})">تعديل</button>
                            <button class="action-btn delete-invoice-btn" onclick="deleteClient(${client.id})">حذف</button>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;

            // إضافة وظيفة البحث
            setupClientSearch();
        }

        // دالة البحث في العملاء
        function setupClientSearch() {
            const searchInput = document.getElementById('clientSearch');
            if (!searchInput) return;

            searchInput.addEventListener('input', function () {
                const searchTerm = this.value.toLowerCase().trim();
                const rows = document.querySelectorAll('#clientsTable tbody tr');

                rows.forEach(row => {
                    const clientName = row.getAttribute('data-client-name').toLowerCase();
                    const clientPhone = row.getAttribute('data-client-phone').toLowerCase();

                    if (clientName.includes(searchTerm) || clientPhone.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        }

        // دالة لتقسيم الصفحات
        function paginateTable(tableId, data, rowsPerPage, currentPage) {
            const tableBody = document.querySelector(`#${tableId} tbody`);
            const totalPages = Math.ceil(data.length / rowsPerPage);
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;

            // عرض البيانات في الصفحة الحالية
            tableBody.innerHTML = data.slice(start, end).map(row => row).join('');

            // تحديث أزرار التنقل
            const paginationControls = document.querySelector(`#${tableId}-pagination`);
            paginationControls.innerHTML = `
            <button onclick="changePage('${tableId}', ${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>السابق</button>
            <span>صفحة ${currentPage} من ${totalPages}</span>
            <button onclick="changePage('${tableId}', ${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>التالي</button>
        `;
        }

        // دالة لتغيير الصفحة
        function changePage(tableId, newPage) {
            const tableData = window[`${tableId}Data`]; // البيانات المخزنة
            const rowsPerPage = 15; // عدد الصفوف لكل صفحة
            paginateTable(tableId, tableData, rowsPerPage, newPage);
        }





        // أضف هذا الكود في نهاية ملف JavaScript

        let notifications = [];
        let unreadCount = 0;

        function addNotification(title, message, type = 'info') {
            const notification = {
                id: Date.now(),
                title,
                message,
                type,
                time: new Date(),
                read: false
            };

            notifications.unshift(notification);
            unreadCount++;
            updateNotificationsCount();
            updateNotificationsList();

            // حفظ الإشعارات في Firebase
            firebaseHelper.saveData('notifications', notifications);
        }

        function toggleNotifications() {
            const panel = document.querySelector('.notifications-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        function updateNotificationsCount() {
            document.querySelector('.notifications-count').textContent = unreadCount;
        }

        function updateNotificationsList() {
            const list = document.getElementById('notificationsList');
            list.innerHTML = notifications.map(notification => `
        <div class="notification-item ${notification.read ? '' : 'unread'}" 
             onclick="markAsRead(${notification.id})">
            <div class="notification-content">
                <div class="notification-title">${notification.title}</div>
                <div class="notification-message">${notification.message}</div>
                <div class="notification-time">
                    ${new Date(notification.time).toLocaleString('ar-EG')}
                </div>
            </div>
        </div>
    `).join('');
        }

        function markAsRead(id) {
            const notification = notifications.find(n => n.id === id);
            if (notification && !notification.read) {
                notification.read = true;
                unreadCount = Math.max(0, unreadCount - 1);
                updateNotificationsCount();
                updateNotificationsList();

                // التحقق مما إذا كانت الإشعار متعلق بفاتورة
                if (notification.title.includes('فاتورة')) {
                    // استخراج رقم الفاتورة من الرسالة
                    const invoiceNumber = notification.message.match(/#\d+/)?.[0];
                    if (invoiceNumber) {
                        // الانتقال إلى قسم الفواتير وتحديد الفاتورة
                        showSection('invoices');
                        highlightInvoice(invoiceNumber);
                    }



                } else if (notification.title.includes('شحنة') || notification.message.includes('شحن')) {
                    showSection('shipping');
                    // تأخير قصير للتأكد من تحميل قسم الشحنات
                    setTimeout(() => {
                        const invoiceNumber = notification.message.match(/#\d+/)?.[0];
                        if (invoiceNumber) {
                            highlightShipment(invoiceNumber);
                        }
                    }, 300);



                }



                // حفظ التغييرات في Firebase
                firebaseHelper.saveData('notifications', notifications);
            }
        }



        // دالة جديدة لتمييز الشحنة
        function highlightShipment(invoiceNumber) {
            const shipmentRow = document.querySelector(`#shipmentsTable tr[data-invoice-number="${invoiceNumber}"]`);
            if (shipmentRow) {
                // التمرير إلى الشحنة
                shipmentRow.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // إضافة تأثير الوميض
                shipmentRow.classList.add('highlight-row');

                // إزالة الوميض بعد انتهاء الأنيميشن
                setTimeout(() => {
                    shipmentRow.classList.remove('highlight-row');
                }, 6000); // 6 ثواني (3 مرات × 2 ثانية)
            }
        }



        // إضافة مراقب للإشعارات في Firebase
        function initNotifications() {
            firebase.database().ref('notifications').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    notifications = data;
                    unreadCount = notifications.filter(n => !n.read).length;
                    updateNotificationsCount();
                    updateNotificationsList();
                }
            });
        }

        // تعديل دالة saveProduct لإضافة إشعار
        function saveProduct() {
            try {
                // جمع بيانات المنتج
                const productName = document.getElementById('productName').value;
                const buyPrice = parseFloat(document.getElementById('buyPrice').value);
                const sellPrice = parseFloat(document.getElementById('sellPrice').value);
                const quantity = parseInt(document.getElementById('quantity').value);
                const imagePreview = document.getElementById('imagePreview');

                // التحقق من البيانات
                if (!productName || isNaN(buyPrice) || isNaN(sellPrice) || isNaN(quantity)) {
                    alert('يرجى ملء جميع الحقول المطلوبة بشكل صحيح');
                    return;
                }

                const defaultImage = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDE1MCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjE1MCIgaGVpZ2h0PSIxNTAiIGZpbGw9IiNFNUU1RTUiLz48dGV4dCB4PSI3NSIgeT0iNzUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiM2NjY2NjYiPtis2YjYsdipINin2YHYqtix2KfYttmK2Kk8L3RleHQ+PC9zdmc+';


                // تجهيز بيانات المنتج
                const productData = {
                    id: Date.now(),
                    name: productName,
                    buyPrice: buyPrice,
                    sellPrice: sellPrice,
                    quantity: quantity,
                    image: imagePreview.src || defaultImage
                };

                const editingId = document.getElementById('productModal').dataset.editingId;

                // تحديث المصفوفة المحلية أولاً
                if (editingId) {
                    const index = products.findIndex(p => p.id === parseInt(editingId));
                    if (index !== -1) {
                        products[index] = { ...products[index], ...productData };
                    }
                } else {
                    products.push(productData);
                }

                // تحديث واجهة المستخدم فوراً
                updateProductsList();
                clearProductForm();
                closeProductModal();

                // إضافة إشعار نجاح
                addNotification(
                    'منتج جديد',
                    `تم ${editingId ? 'تحديث' : 'إضافة'} المنتج "${productName}" بنجاح`,
                    'success'
                );

                // حفظ في Firebase بعد تحديث الواجهة
                firebaseHelper.saveData('products', products)
                    .catch(error => {
                        console.error('خطأ في حفظ المنتج:', error);
                        addNotification(
                            'خطأ',
                            'حدث خطأ أثناء حفظ المنتج في قاعدة البيانات',
                            'error'
                        );
                    });

                // الانتقال إلى قسم المنتجات وتمييز المنتج الجديد
                showSection('products');
                const productRow = document.querySelector(`tr[data-product-name="${productName}"]`);
                if (productRow) {
                    productRow.classList.add('highlight-row');
                    setTimeout(() => {
                        productRow.classList.remove('highlight-row');
                    }, 6000);
                }

            } catch (error) {
                console.error('خطأ:', error);
                addNotification('خطأ', 'حدث خطأ غير متوقع', 'error');
            }
        }

        function deleteProduct(id) {
            if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
                // تحديث المصفوفة المحلية أولاً
                products = products.filter(p => p.id !== parseInt(id));

                // تحديث واجهة المستخدم فوراً
                updateProductsList();

                // إضافة إشعار نجاح
                addNotification(
                    'حذف منتج',
                    'تم حذف المنتج بنجاح',
                    'success'
                );

                // حفظ في Firebase بعد تحديث الواجهة
                firebaseHelper.saveData('products', products)
                    .catch(error => {
                        console.error('خطأ في حذف المنتج:', error);
                        addNotification(
                            'خطأ',
                            'حدث خطأ أثناء حذف المنتج من قاعدة البيانات',
                            'error'
                        );
                    });
            }
        }

        // تعديل دالة saveFullInvoice لإضافة إشعار
        function saveFullInvoice() {
            // تجميع بيانات الفاتورة
            const newInvoice = {
                number: document.getElementById('invoiceNumber').value,
                date: document.getElementById('invoiceDate').value,
                customer: document.getElementById('customerName').value,
                phone: document.getElementById('phone').value,
                governorate: document.getElementById('governorate').value,
                address: document.getElementById('address').value,
                items: [...document.getElementById('invoiceItems').rows].map(row => ({
                    name: row.querySelector('.item-name').value,
                    price: Number(row.querySelector('.item-price').value),
                    quantity: Number(row.querySelector('.item-quantity').value),
                    total: Number(row.querySelector('.item-total').value)
                })),
                // إضافة قيمة التوصيل
                shippingCost: Number(document.getElementById('shippingCost').value) || 0,
                items: [...document.getElementById('invoiceItems').rows].map(row => ({
                    name: row.querySelector('.item-name').value,
                    price: Number(row.querySelector('.item-price').value),
                    quantity: Number(row.querySelector('.item-quantity').value),
                    total: Number(row.querySelector('.item-total').value)
                })),
                total: Number(document.getElementById('totalAmount').value),
                discount: Number(document.getElementById('discountAmount').value) || 0,
                finalTotal: Number(document.getElementById('finalTotalAmount').value)
            };

            const editIndex = parseInt(document.getElementById('invoiceModal').dataset.editIndex);
            const isEditing = !isNaN(editIndex);

            if (isEditing) {
                newInvoice.shipped = invoices[editIndex].shipped || false;
                invoices[editIndex] = newInvoice;
                document.getElementById('invoiceModal').removeAttribute('data-edit-index');
            } else {
                invoices.push(newInvoice);
                invoiceCounter++;
            }

            // حفظ في Firebase
            firebaseHelper.saveData('invoices', invoices)
                .then(() => {
                    closeInvoiceModal();
                    clearInvoiceForm();

                    // إضافة إشعار
                    addNotification(
                        'فاتورة جديدة',
                        `تم ${isEditing ? 'تحديث' : 'إنشاء'} الفاتورة رقم ${newInvoice.number} بنجاح`,
                        'success'
                    );

                    // الانتقال إلى قسم الفواتير
                    showSection('invoices');

                    // حساب الصفحة التي تحتوي على الفاتورة
                    const invoiceIndex = isEditing ? editIndex : invoices.length - 1;
                    const page = Math.floor(invoiceIndex / 10) + 1;

                    // تحديث جدول الفواتير وعرض الصفحة المناسبة
                    updateInvoicesTable();
                    setTimeout(() => {
                        paginateInvoices(page);
                        // تمييز الفاتورة
                        setTimeout(() => {
                            const row = document.querySelector(`tr[data-invoice-number="${newInvoice.number}"]`);
                            if (row) {
                                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                row.classList.add('highlight-row');
                                setTimeout(() => {
                                    row.classList.remove('highlight-row');
                                }, 6000);
                            }
                        }, 100);
                    }, 100);
                })
                .catch(error => {
                    console.error('خطأ في حفظ الفاتورة:', error);
                    addNotification(
                        'خطأ',
                        'حدث خطأ أثناء حفظ الفاتورة',
                        'error'
                    );
                });
        }










        // إضافة استدعاء initNotifications عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            showSection('invoices');
            initNotifications();
        });

        // دالة لضغط الصور
        function compressImage(imageDataUrl, maxWidth = 800) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = imageDataUrl;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // حساب الأبعاد الجديدة مع الحفاظ على النسبة
                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth) {
                        height = (maxWidth * height) / width;
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;

                    ctx.drawImage(img, 0, 0, width, height);

                    // ضغط الصورة بجودة 0.7
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
            });
        }

        // بعد دالة updateProductsPaginationControls مباشرة

        function updateClientsList() {
            const clientsSection = document.getElementById('clients');

            // إضافة مربع البحث وزر إضافة عميل جديد
            if (!document.querySelector('.clients-controls')) {
                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'clients-controls';
                controlsDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;';
                controlsDiv.innerHTML = `
            <button class="new-invoice-btn" onclick="showNewClientForm()">إضافة عميل جديد</button>
            <div class="search-box">
                <input type="text" id="clientSearch" placeholder="البحث باسم العميل أو رقم الهاتف" class="search-input">
                <i class="fas fa-search search-icon"></i>
            </div>
        `;

                const titleElement = clientsSection.querySelector('.section-title');
                titleElement.insertAdjacentElement('afterend', controlsDiv);
            }

            // إنشاء جدول العملاء وعناصر التنقل
            if (!document.getElementById('clientsTable')) {
                clientsSection.innerHTML += `
            <table id="clientsTable" class="invoice-table">
                <thead>
                    <tr>
                        <th>اسم العميل</th>
                        <th>المحافظة</th>
                        <th>رقم الهاتف</th>
                        <th>العنوان</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div id="clientsPagination" style="margin-top: 20px; text-align: center;"></div>
        `;
            }

            // عرض الصفحة الأولى من العملاء
            paginateClients(1);

            // إضافة وظيفة البحث
            setupClientSearch();
        }

        // دالة لتقسيم صفحات العملاء
        function paginateClients(pageNumber) {
            const clientsPerPage = 10;
            const tbody = document.getElementById('clientsTable').querySelector('tbody');
            const totalPages = Math.ceil(clients.length / clientsPerPage);
            const start = (pageNumber - 1) * clientsPerPage;
            const end = start + clientsPerPage;

            // عرض العملاء للصفحة الحالية
            tbody.innerHTML = clients.slice(start, end).map(client => `
        <tr data-client-name="${client.name}" data-client-phone="${client.phone}">
            <td>${client.name}</td>
            <td>${client.governorate}</td>
            <td>${client.phone}</td>
            <td>${client.address}</td>
            <td>
                <button class="action-btn edit-btn" onclick="editClient(${client.id})" title="تعديل">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn delete-invoice-btn" onclick="deleteClient(${client.id})" title="حذف">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');

            // تحديث أزرار التنقل
            updateClientsPaginationControls(pageNumber, totalPages);
        }

        // دالة لتحديث أزرار التنقل للعملاء
        function updateClientsPaginationControls(currentPage, totalPages) {
            const paginationDiv = document.getElementById('clientsPagination');
            paginationDiv.innerHTML = `
        <button onclick="paginateClients(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>السابق</button>
        <span>صفحة ${currentPage} من ${totalPages}</span>
        <button onclick="paginateClients(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>التالي</button>
    `;
        }






        function highlightShipment(invoiceNumber) {
            // التأكد من عرض الصفحة التي تحتوي على الشحنة
            const shipment = invoices.find(inv => inv.shipped && inv.number === invoiceNumber);
            if (!shipment) return;

            const shipmentIndex = invoices.filter(inv => inv.shipped).indexOf(shipment);
            const page = Math.floor(shipmentIndex / 10) + 1;

            // تحديث جدول الشحنات وعرض الصفحة المناسبة
            paginateShipmentsTable(page);

            // انتظار لحظة حتى يتم تحديث الجدول
            setTimeout(() => {
                const row = document.querySelector(`#shipmentsTable tr[data-invoice-number="${invoiceNumber}"]`);
                if (row) {
                    // التمرير إلى الشحنة
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    // إضافة تأثير الوميض
                    row.classList.add('highlight-row');

                    // إزالة الوميض بعد انتهاء الأنيميشن
                    setTimeout(() => {
                        row.classList.remove('highlight-row');
                    }, 6000); // 6 ثواني (3 مرات × 2 ثانية)
                }
            }, 300);
        }









        function highlightInvoice(invoiceNumber) {
            // التأكد من عرض الصفحة التي تحتوي على الفاتورة
            const invoice = invoices.find(inv => inv.number === invoiceNumber);
            if (!invoice) return;

            const invoiceIndex = invoices.indexOf(invoice);
            const page = Math.floor(invoiceIndex / 10) + 1;
            paginateInvoices(page);

            // انتظار لحظة حتى يتم تحديث الجدول
            setTimeout(() => {
                const row = document.querySelector(`#invoicesTable tr[data-invoice-number="${invoiceNumber}"]`);
                if (row) {
                    // التمرير إلى الفاتورة
                    row.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    // إضافة تأثير الوميض
                    row.classList.add('highlight-row');

                    // إزالة الوميض بعد انتهاء الأنيميشن
                    setTimeout(() => {
                        row.classList.remove('highlight-row');
                    }, 6000); // 6 ثواني (3 مرات × 2 ثانية)
                }
            }, 100);
        }







        // إضافة الدوال الجديدة في ملف JavaScript
        let shippingRates = {};

        function showShippingSettings() {
            const modal = document.getElementById('shippingSettingsModal');
            const tbody = document.getElementById('shippingRatesTable');

            // قائمة المحافظات المصرية
            const governorates = [
                "القاهرة", "الجيزة", "الإسكندرية", "الدقهلية", "البحر الأحمر", "البحيرة",
                "الفيوم", "الغربية", "الإسماعيلية", "المنوفية", "المنيا", "القليوبية",
                "الوادي الجديد", "السويس", "اسوان", "اسيوط", "بني سويف", "بورسعيد",
                "دمياط", "الشرقية", "جنوب سيناء", "كفر الشيخ", "مطروح", "الأقصر",
                "قنا", "شمال سيناء", "سوهاج"
            ];

            // تحميل الأسعار المحفوظة
            firebaseHelper.getData('shippingRates').then(rates => {
                shippingRates = rates || {};

                // إنشاء صفوف الجدول
                tbody.innerHTML = governorates.map(gov => {
                    const rate = shippingRates[gov] || { price: 0, duration: 1 };
                    return `
                <tr>
                    <td>${gov}</td>
                    <td>
                        <input type="number" 
                               class="shipping-rate" 
                               value="${rate.price}" 
                               data-governorate="${gov}" 
                               min="0">
                    </td>
                    <td>
                        <input type="number" 
                               class="shipping-duration" 
                               value="${rate.duration}" 
                               data-governorate="${gov}" 
                               min="1">
                    </td>
                </tr>
            `;
                }).join('');
            });

            modal.style.display = 'block';
        }

        function closeShippingSettings() {
            document.getElementById('shippingSettingsModal').style.display = 'none';
        }

        function saveShippingSettings() {
            const rates = {};
            const rateInputs = document.querySelectorAll('.shipping-rate');
            const durationInputs = document.querySelectorAll('.shipping-duration');

            rateInputs.forEach((input, index) => {
                const governorate = input.dataset.governorate;
                rates[governorate] = {
                    price: parseFloat(input.value) || 0,
                    duration: parseInt(durationInputs[index].value) || 1
                };
            });

            // حفظ في Firebase
            firebaseHelper.saveData('shippingRates', rates)
                .then(() => {
                    shippingRates = rates;
                    closeShippingSettings();
                    addNotification(
                        'أسعار الشحن',
                        'تم حفظ أسعار الشحن بنجاح',
                        'success'
                    );
                })
                .catch(error => {
                    console.error('خطأ في حفظ أسعار الشحن:', error);
                    addNotification(
                        'خطأ',
                        'حدث خطأ أثناء حفظ أسعار الشحن',
                        'error'
                    );
                });
        }

        // تحميل أسعار الشحن عند بدء التطبيق
        document.addEventListener('DOMContentLoaded', () => {
            firebaseHelper.getData('shippingRates')
                .then(rates => {
                    if (rates) {
                        shippingRates = rates;
                    }
                });
        });




        function showProfitsReport() {
    const modal = document.getElementById('profitsModal');
    const modalContent = modal.querySelector('.modal-content');

    // إضافة مربع البحث
    if (!modalContent.querySelector('.search-box')) {
        const searchBox = document.createElement('div');
        searchBox.className = 'search-box';
        searchBox.style.marginBottom = '20px';
        searchBox.innerHTML = `
            <input type="text" id="profitSearch" placeholder="البحث برقم الفاتورة" class="search-input">
            <i class="fas fa-search search-icon"></i>
        `;
        modalContent.insertBefore(searchBox, modalContent.querySelector('table'));
    }

     // إضافة مربع البحث وفلتر التاريخ
     if (!modalContent.querySelector('.filter-controls')) {
        const filterControls = document.createElement('div');
        filterControls.className = 'filter-controls';
        filterControls.style.marginBottom = '20px';
        filterControls.innerHTML = `
            <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 20px;">
                
                <div style="display: flex; gap: 10px; align-items: center;">
                    <label>من:</label>
                    <input type="date" id="startDate" class="date-input">
                    <label>إلى:</label>
                    <input type="date" id="endDate" class="date-input">
                    <button onclick="filterProfitsByDate()" class="filter-btn">
                        <i class="fas fa-filter"></i> تصفية
                    </button>
                    <button onclick="resetProfitsFilter()" class="filter-btn" title="إعادة تعيين">
                <i class="fas fa-sync-alt"></i>
            </button>
                </div>
            </div>
        `;
        modalContent.insertBefore(filterControls, modalContent.querySelector('table'));
    }

    // التحقق من وجود الفواتير
    if (!invoices || invoices.length === 0) {
        document.getElementById('profitsTableBody').innerHTML = '<tr><td colspan="5">لا توجد فواتير</td></tr>';
        return;
    }

    // تصفية الفواتير المدفوعة فقط
    const paidInvoices = invoices.filter(invoice => invoice.paid === true);

    // التحقق من وجود فواتير مدفوعة
    if (paidInvoices.length === 0) {
        document.getElementById('profitsTableBody').innerHTML = '<tr><td colspan="5">لا توجد فواتير مدفوعة</td></tr>';
        return;
    }

    // تجميع بيانات الأرباح
    window.profitsTableData = paidInvoices
        .map(invoice => {
            try {
                // حساب إجمالي تكلفة الشراء
                const totalBuyingCost = invoice.items.reduce((sum, item) => {
                    const product = products.find(p => p.name === item.name);
                    const buyPrice = product ? product.buyPrice : 0;
                    return sum + (buyPrice * item.quantity);
                }, 0);

                // حساب إجمالي سعر البيع
                const totalSellingPrice = invoice.items.reduce((sum, item) => {
                    return sum + (item.price * item.quantity);
                }, 0);

                const discount = invoice.discount || 0;
                const profit = totalSellingPrice - totalBuyingCost - discount;

                return {
                    invoiceNumber: invoice.number,
                    totalBuying: totalBuyingCost,
                    totalSelling: totalSellingPrice,
                    discount: discount,
                    profit: profit
                };
            } catch (error) {
                console.error('خطأ في معالجة الفاتورة:', invoice.number, error);
                return null;
            }
        })
        .filter(data => data !== null && data.totalBuying > 0);

    // التحقق من وجود بيانات أرباح
    if (window.profitsTableData.length === 0) {
        document.getElementById('profitsTableBody').innerHTML = '<tr><td colspan="5">لا توجد بيانات أرباح متاحة</td></tr>';
        return;
    }

    // إضافة عناصر التنقل بين الصفحات
    if (!modalContent.querySelector('.profits-pagination')) {
        const paginationDiv = document.createElement('div');
        paginationDiv.className = 'profits-pagination pagination-controls';
        modalContent.appendChild(paginationDiv);
    }

    // عرض الصفحة الأولى
    paginateProfitsTable(1);

    // إضافة وظيفة البحث
    setupProfitSearch();

    // عرض النافذة المنبثقة
    modal.style.display = 'block';
}


// إضافة دالة جديدة لإعادة تعيين الفلتر
function resetProfitsFilter() {
    // إعادة تعيين حقول التاريخ
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    
    // إعادة تحميل كل البيانات
    const paidInvoices = invoices.filter(invoice => invoice.paid === true);
    updateProfitsTable(paidInvoices);
    
    // إضافة تأثير دوران للأيقونة
    const resetIcon = document.querySelector('.fa-sync-alt');
    resetIcon.style.animation = 'spin 1s linear';
    
    // إزالة الأنيميشن بعد اكتمالها
    setTimeout(() => {
        resetIcon.style.animation = '';
    }, 1000);
}


// دالة لفلترة الأرباح حسب التاريخ
function filterProfitsByDate() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    // التحقق من إدخال التواريخ
    if (!startDate || !endDate) {
        alert('الرجاء اختيار تواريخ صحيحة');
        return;
    }

    // تحويل التواريخ إلى تنسيق قابل للمقارنة
    const startParts = startDate.split('-');
    const endParts = endDate.split('-');
    
    const startDateObj = new Date(startParts[0], startParts[1] - 1, startParts[2]);
    const endDateObj = new Date(endParts[0], endParts[1] - 1, endParts[2]);
    endDateObj.setHours(23, 59, 59);

    // فلترة الفواتير حسب التاريخ
    const filteredInvoices = invoices.filter(invoice => {
        try {
            // تحويل تاريخ الفاتورة (DD/MM/YYYY) إلى كائن Date
            const [day, month, year] = invoice.date.split('/');
            const invoiceDate = new Date(year, month - 1, day);
            
            // للتحقق من عملية التحويل
            console.log({
                invoiceDate: invoiceDate.toISOString(),
                invoiceNumber: invoice.number,
                startDate: startDateObj.toISOString(),
                endDate: endDateObj.toISOString()
            });

            return invoice.paid && 
                   invoiceDate >= startDateObj && 
                   invoiceDate <= endDateObj;
        } catch (error) {
            console.error('خطأ في معالجة تاريخ الفاتورة:', invoice.date, error);
            return false;
        }
    });

    console.log('Filtered Invoices:', filteredInvoices.length);
    updateProfitsTable(filteredInvoices);
}

function filterProfitsByDate() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;

    // التحقق من إدخال التواريخ
    if (!startDate || !endDate) {
        alert('الرجاء اختيار تواريخ صحيحة');
        return;
    }

    // تحويل تواريخ الفلتر إلى كائنات Date
    const startDateObj = new Date(startDate);
    const endDateObj = new Date(endDate);
    endDateObj.setHours(23, 59, 59);

    // فلترة الفواتير حسب التاريخ
    const filteredInvoices = invoices.filter(invoice => {
        try {
            // تحويل تاريخ الفاتورة من DD/MM/YYYY إلى كائن Date
            const [day, month, year] = invoice.date.split('/');
            const invoiceDate = new Date(
                parseInt(year),
                parseInt(month) - 1, // الشهر يبدأ من 0
                parseInt(day)
            );
            invoiceDate.setHours(0, 0, 0, 0);

            // للتحقق من صحة التحويل
            console.log({
                invoice: invoice.number,
                invoiceDate: invoiceDate.toISOString(),
                startDate: startDateObj.toISOString(),
                endDate: endDateObj.toISOString(),
                isWithinRange: invoiceDate >= startDateObj && invoiceDate <= endDateObj
            });

            return invoice.paid && 
                   invoiceDate >= startDateObj && 
                   invoiceDate <= endDateObj;
        } catch (error) {
            console.error('خطأ في معالجة تاريخ الفاتورة:', invoice.date, error);
            return false;
        }
    });

    console.log('عدد الفواتير المفلترة:', filteredInvoices.length);
    updateProfitsTable(filteredInvoices);








}




// دالة لتحديث جدول الأرباح
function updateProfitsTable(filteredInvoices) {
    // تجميع بيانات الأرباح للفواتير المفلترة
    window.profitsTableData = filteredInvoices
        .map(invoice => {
            try {
                const totalBuyingCost = invoice.items.reduce((sum, item) => {
                    const product = products.find(p => p.name === item.name);
                    const buyPrice = product ? product.buyPrice : 0;
                    return sum + (buyPrice * item.quantity);
                }, 0);

                const totalSellingPrice = invoice.items.reduce((sum, item) => {
                    return sum + (item.price * item.quantity);
                }, 0);

                const discount = invoice.discount || 0;
                const profit = totalSellingPrice - totalBuyingCost - discount;

                return {
                    invoiceNumber: invoice.number,
                    totalBuying: totalBuyingCost,
                    totalSelling: totalSellingPrice,
                    discount: discount,
                    profit: profit
                };
            } catch (error) {
                console.error('خطأ في معالجة الفاتورة:', invoice.number, error);
                return null;
            }
        })
        .filter(data => data !== null && data.totalBuying > 0);

    // عرض رسالة إذا لم توجد نتائج
    if (window.profitsTableData.length === 0) {
        document.getElementById('profitsTableBody').innerHTML = 
            '<tr><td colspan="5">لا توجد بيانات أرباح في الفترة المحددة</td></tr>';
        return;
    }

    // عرض الصفحة الأولى من النتائج المفلترة
    paginateProfitsTable(1);
}








function paginateProfitsTable(pageNumber) {
    const itemsPerPage = 10;
    const tbody = document.getElementById('profitsTableBody');
    const data = window.profitsTableData;
    const totalPages = Math.ceil(data.length / itemsPerPage);
    const start = (pageNumber - 1) * itemsPerPage;
    const end = start + itemsPerPage;

    // عرض البيانات للصفحة الحالية
    const pageData = data.slice(start, end);
    tbody.innerHTML = pageData.map(data => `
        <tr data-invoice-number="${data.invoiceNumber}">
            <td>${data.invoiceNumber}</td>
            <td>${data.totalBuying.toFixed(2)} ج.م</td>
            <td>${data.totalSelling.toFixed(2)} ج.م</td>
            <td>${data.discount.toFixed(2)} ج.م</td>
            <td>${data.profit.toFixed(2)} ج.م</td>
        </tr>
    `).join('');

    // تحديث الإجماليات
    updateProfitsTotals(window.profitsTableData);

    // تحديث أزرار التنقل
    const paginationDiv = document.querySelector('.profits-pagination');
    paginationDiv.innerHTML = `
        <button onclick="paginateProfitsTable(${pageNumber - 1})" 
                ${pageNumber === 1 ? 'disabled' : ''}>
            السابق
        </button>
        <span>صفحة ${pageNumber} من ${totalPages}</span>
        <button onclick="paginateProfitsTable(${pageNumber + 1})" 
                ${pageNumber === totalPages ? 'disabled' : ''}>
            التالي
        </button>
    `;
}


        function updateProfitsTotals(data) {
    const totalBuying = data.reduce((sum, item) => sum + item.totalBuying, 0);
    const totalSelling = data.reduce((sum, item) => sum + item.totalSelling, 0);
    const totalDiscount = data.reduce((sum, item) => sum + item.discount, 0);
    const totalProfit = data.reduce((sum, item) => sum + item.profit, 0);

    document.getElementById('totalBuying').textContent = totalBuying.toFixed(2) + ' ج.م';
    document.getElementById('totalValue').textContent = totalSelling.toFixed(2) + ' ج.م';
    document.getElementById('totalDiscount').textContent = totalDiscount.toFixed(2) + ' ج.م';
    document.getElementById('totalProfit').textContent = totalProfit.toFixed(2) + ' ج.م';
}









        // دالة البحث في جدول الأرباح
        function setupProfitSearch() {
            const searchInput = document.getElementById('profitSearch');
            if (!searchInput) return;

            searchInput.addEventListener('input', function () {
                const searchTerm = this.value.toLowerCase().trim();
                const rows = document.querySelectorAll('#profitsTableBody tr');

                rows.forEach(row => {
                    const invoiceNumber = row.getAttribute('data-invoice-number').toLowerCase();
                    if (invoiceNumber.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        }

        function closeProfitsModal() {
            const modal = document.getElementById('profitsModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }





        // إضافة مستمعات الأحداث لجميع النماذج
document.addEventListener('DOMContentLoaded', () => {
    // قائمة بجميع النماذج في التطبيق
    const modals = [
        'invoiceModal',
        'productModal',
        'clientModal',
        'profitsModal',
        'shippingSettingsModal',
        'qrModal',
        'detailsModal'
    ];

    // إضافة مستمع حدث لكل نموذج
    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.addEventListener('click', (event) => {
                // إذا تم النقر على الخلفية (وليس على المحتوى)
                if (event.target === modal) {
                    // إغلاق النموذج
                    modal.style.display = 'none';
                    
                    // إذا كان النموذج هو نموذج الفاتورة، قم بتنظيف النموذج
                    if (modalId === 'invoiceModal') {
                        clearInvoiceForm();
                    }
                    // إذا كان النموذج هو نموذج المنتج، قم بتنظيف النموذج
                    else if (modalId === 'productModal') {
                        clearProductForm();
                    }
                    // إذا كان النموذج هو نموذج العميل، قم بتنظيف النموذج
                    else if (modalId === 'clientModal') {
                        clearClientForm();
                    }
                }
            });
        }
    });

    // إضافة معالج خاص للنوافذ المنبثقة الديناميكية
    document.addEventListener('click', (event) => {
        if (event.target.classList.contains('large-image-modal')) {
            event.target.remove();
        }
    });
});



    </script>
    <div class="notifications-panel">
        <div id="notificationsList"></div>
    </div>
</body>

</html>
